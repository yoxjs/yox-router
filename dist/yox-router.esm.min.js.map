{"version":3,"file":"yox-router.esm.min.js","sources":["../src/constant.ts","../../yox-config/src/config.ts","../src/Hooks.ts","../src/util/value.ts","../src/mode/hash.ts","../src/mode/history.ts","../src/Router.ts","../src/util/query.ts"],"sourcesContent":["export const WINDOW = window\n\nexport const LOCATION = WINDOW.location\n\nexport const HISTORY = WINDOW.history\n\nexport const UNDEFINED = void 0\n\nexport const NULL = null\n\nexport const TRUE = true\n\nexport const FALSE = false\n\nexport const RAW_NULL = 'null'\n\nexport const RAW_TRUE = 'true'\n\nexport const RAW_FALSE = 'false'\n\n// path 中的参数前缀，如 /user/:userId\nexport const PREFIX_PARAM = ':'\n\n// path 分隔符\nexport const SEPARATOR_PATH = '/'\n\n// path 和 search 的分隔符\nexport const SEPARATOR_SEARCH = '?'\n\n// query 分隔符\nexport const SEPARATOR_QUERY = '&'\n\n// 键值对分隔符\nexport const SEPARATOR_PAIR = '='\n\n// 参数中的数组标识\nexport const FLAG_ARRAY = '[]'\n\n// history 模式\nexport const MODE_HISTORY = 'history'\n\n// 导航钩子 - 路由进入之前\nexport const ROUTER_HOOK_BEFORE_ENTER = 'beforeEnter'\n\n// 导航钩子 - 路由进入之后\nexport const ROUTER_HOOK_AFTER_ENTER = 'afterEnter'\n\n// 导航钩子 - 路由更新之前\nexport const ROUTER_HOOK_BEFORE_UPDATE = 'beforeUpdate'\n\n// 导航钩子 - 路由更新之后\nexport const ROUTER_HOOK_AFTER_UPDATE = 'afterUpdate'\n\n// 导航钩子 - 路由离开之前\nexport const ROUTER_HOOK_BEFORE_LEAVE = 'beforeLeave'\n\n// 导航钩子 - 路由离开之后\nexport const ROUTER_HOOK_AFTER_LEAVE = 'afterLeave'","export const SYNTAX_IF = '#if'\nexport const SYNTAX_ELSE = 'else'\nexport const SYNTAX_ELSE_IF = 'else if'\nexport const SYNTAX_EACH = '#each'\nexport const SYNTAX_PARTIAL = '#partial'\nexport const SYNTAX_IMPORT = '>'\nexport const SYNTAX_SPREAD = '...'\nexport const SYNTAX_COMMENT = /^!\\s/\n\nexport const SLOT_DATA_PREFIX = '$slot_'\nexport const SLOT_NAME_DEFAULT = 'children'\n\nexport const HINT_STRING = 1\nexport const HINT_NUMBER = 2\nexport const HINT_BOOLEAN = 3\n\nexport const DIRECTIVE_ON = 'on'\nexport const DIRECTIVE_LAZY = 'lazy'\nexport const DIRECTIVE_MODEL = 'model'\nexport const DIRECTIVE_EVENT = 'event'\nexport const DIRECTIVE_BINDING = 'binding'\nexport const DIRECTIVE_CUSTOM = 'o'\n\nexport const MODIFER_NATIVE = 'native'\n\nexport const MODEL_PROP_DEFAULT = 'value'\n\nexport const NAMESPACE_HOOK = '.hook'\n\nexport const HOOK_BEFORE_CREATE = 'beforeCreate'\nexport const HOOK_AFTER_CREATE = 'afterCreate'\nexport const HOOK_BEFORE_MOUNT = 'beforeMount'\nexport const HOOK_AFTER_MOUNT = 'afterMount'\nexport const HOOK_BEFORE_UPDATE = 'beforeUpdate'\nexport const HOOK_AFTER_UPDATE = 'afterUpdate'\nexport const HOOK_BEFORE_DESTROY = 'beforeDestroy'\nexport const HOOK_AFTER_DESTROY = 'afterDestroy'\n\n// 路由钩子\nexport const HOOK_BEFORE_ROUTE_ENTER = 'beforeRouteEnter'\nexport const HOOK_AFTER_ROUTE_ENTER = 'afterRouteEnter'\nexport const HOOK_BEFORE_ROUTE_UPDATE = 'beforeRouteUpdate'\nexport const HOOK_AFTER_ROUTE_UPDATE = 'afterRouteUpdate'\nexport const HOOK_BEFORE_ROUTE_LEAVE = 'beforeRouteLeave'\nexport const HOOK_AFTER_ROUTE_LEAVE = 'afterRouteLeave'\n","import {\n  Task,\n} from '../../yox-type/src/type'\n\nimport {\n  Location,\n} from '../../yox-type/src/router'\n\nexport default class Hooks {\n\n  list: Task[]\n\n  to: Location\n\n  from: Location | void\n\n  setLocation(to: Location, from: Location | void) {\n    this.to = to\n    this.from = from\n    return this\n  }\n\n  clear() {\n    this.list = []\n    return this\n  }\n\n  add(hook: Function | void, ctx: any) {\n    const { list } = this\n    if (hook) {\n      list.push({\n        fn: hook,\n        ctx,\n      })\n    }\n    return this\n  }\n\n  next(next: Function, isGuard?: boolean, callback?: Function) {\n    const task = this.list.shift()\n    if (task) {\n      if (isGuard) {\n        task.fn.call(task.ctx, this.to, this.from, next)\n      }\n      else {\n        task.fn.call(task.ctx, this.to, this.from)\n        next()\n      }\n    }\n    else if (callback) {\n      callback()\n    }\n  }\n\n}","import {\n  API,\n} from '../type'\n\nimport {\n  NULL,\n  TRUE,\n  FALSE,\n  RAW_NULL,\n  RAW_TRUE,\n  RAW_FALSE,\n} from '../constant'\n\n/**\n * 把字符串 value 解析成最合适的类型\n */\nexport function parse(API: API, value: string) {\n  let result: any\n  if (API.is.numeric(value)) {\n    result = +value\n  }\n  else if (API.is.string(value)) {\n    if (value === RAW_TRUE) {\n      result = TRUE\n    }\n    else if (value === RAW_FALSE) {\n      result = FALSE\n    }\n    else if (value === RAW_NULL) {\n      result = NULL\n    }\n    else {\n      result = decodeURIComponent(value)\n    }\n  }\n  return result\n}\n\nexport function stringify(API: API, value: any): string | void {\n  if (API.is.string(value)) {\n    return encodeURIComponent(value)\n  }\n  else if (API.is.number(value) || API.is.boolean(value)) {\n    return value.toString()\n  }\n  else if (value === NULL) {\n    return RAW_NULL\n  }\n}","import {\n  Location,\n} from '../../../yox-type/src/router'\n\nimport {\n  DomApi,\n} from '../../../yox-type/src/api'\n\nimport {\n  Listener,\n} from '../../../yox-type/src/type'\n\nimport {\n  WINDOW,\n  HISTORY,\n  LOCATION,\n  SEPARATOR_PATH,\n} from '../constant'\n\n// hash 前缀，Google 的规范是 #! 开头，如 #!/path/sub?key=value\nconst HASH_PREFIX = '#!',\n\nHASH_CHANGE = 'hashchange'\n\nexport function start(api: DomApi, handler: Function) {\n  api.on(WINDOW, HASH_CHANGE, handler as Listener)\n  handler()\n}\n\nexport function stop(api: DomApi, handler: Function) {\n  api.off(WINDOW, HASH_CHANGE, handler)\n}\n\nexport function push(location: Location, handler: Function) {\n  LOCATION.hash = HASH_PREFIX + location.url\n}\n\nexport function go(n: number) {\n  HISTORY.go(n)\n}\n\nexport function current() {\n\n  // 不能直接读取 window.location.hash\n  // 因为 Firefox 会做 pre-decode\n  const href = LOCATION.href, index = href.indexOf(HASH_PREFIX)\n\n  return index > 0\n    ? href.substr(index + HASH_PREFIX.length)\n    : SEPARATOR_PATH\n\n}\n","import {\n  Location,\n} from '../../../yox-type/src/router'\n\nimport {\n  DomApi,\n} from '../../../yox-type/src/api'\n\nimport {\n  Listener,\n} from '../../../yox-type/src/type'\n\nimport {\n  WINDOW,\n  HISTORY,\n  LOCATION,\n} from '../constant'\n\nconst POP_STATE = 'popstate'\n\nexport const isSupported = 'pushState' in HISTORY\n\nexport function start(api: DomApi, handler: Function) {\n  api.on(WINDOW, POP_STATE, handler as Listener)\n  handler()\n}\n\nexport function stop(api: DomApi, handler: Function) {\n  api.off(WINDOW, POP_STATE, handler)\n}\n\nexport function push(location: Location, handler: Function) {\n  // 调用 pushState 不会触发 popstate 事件\n  // 因此这里需要手动调用一次 handler\n  HISTORY.pushState({}, '', location.url)\n  handler()\n}\n\nexport function go(n: number) {\n  HISTORY.go(n)\n}\n\nexport function current() {\n  return LOCATION.pathname + LOCATION.search\n}\n","import {\n  Data,\n  Listener,\n} from '../../yox-type/src/type'\n\nimport {\n  Location,\n  RouteTarget,\n} from '../../yox-type/src/router'\n\nimport {\n  VNode,\n  Directive,\n} from '../../yox-type/src/vnode'\n\nimport {\n  ComponentOptions,\n} from '../../yox-type/src/options'\n\nimport {\n  CustomEventInterface,\n} from '../../yox-type/src/emitter'\n\nimport {\n  YoxInterface,\n} from '../../yox-type/src/yox'\n\nimport {\n  TRUE,\n  FALSE,\n  UNDEFINED,\n\n  MODE_HISTORY,\n  PREFIX_PARAM,\n  SEPARATOR_PATH,\n  SEPARATOR_SEARCH,\n\n  ROUTER_HOOK_BEFORE_ENTER,\n  ROUTER_HOOK_AFTER_ENTER,\n  ROUTER_HOOK_BEFORE_UPDATE,\n  ROUTER_HOOK_AFTER_UPDATE,\n  ROUTER_HOOK_BEFORE_LEAVE,\n  ROUTER_HOOK_AFTER_LEAVE,\n} from './constant'\n\nimport {\n  API,\n  Mode,\n  Target,\n  RouterOptions,\n  RouteOptions,\n  LinkedRoute,\n  RoutePending,\n  Redirect,\n  RouteCallback,\n} from './type'\n\nimport {\n  HOOK_BEFORE_ROUTE_ENTER,\n  HOOK_AFTER_ROUTE_ENTER,\n  HOOK_BEFORE_ROUTE_UPDATE,\n  HOOK_AFTER_ROUTE_UPDATE,\n  HOOK_BEFORE_ROUTE_LEAVE,\n  HOOK_AFTER_ROUTE_LEAVE,\n} from '../../yox-config/src/config'\n\nimport Hooks from './Hooks'\n\nimport * as queryUtil from './util/query'\nimport * as valueUtil from './util/value'\n\nimport * as hashMode from './mode/hash'\nimport * as historyMode from './mode/history'\n\nlet API: API, hookEvents: Record<string, Listener>, guid = 0\n\nconst ROUTER = '$router',\n\nROUTE = '$route',\n\nROUTE_VIEW = '$routeView',\n\nROUTE_COMPONENT = 'RouteComponent',\n\nEVENT_CLICK = 'click',\n\nEMPTY_FUNCTION = new Function()\n\n/**\n * 格式化路径，确保它以 / 开头，不以 / 结尾\n */\nfunction formatPath(path: string, parentPath: string | void) {\n\n  // 如果不是 / 开头，表示是相对路径\n  if (!API.string.startsWith(path, SEPARATOR_PATH)) {\n    // 确保 parentPath 以 / 结尾\n    if (parentPath) {\n      if (!API.string.endsWith(parentPath, SEPARATOR_PATH)) {\n        parentPath += SEPARATOR_PATH\n      }\n    }\n    else {\n      parentPath = SEPARATOR_PATH\n    }\n    path = parentPath + path\n  }\n\n  // 如果 path 以 / 结尾，删掉它\n  if (path !== SEPARATOR_PATH\n    && API.string.endsWith(path, SEPARATOR_PATH)\n  ) {\n    path = API.string.slice(path, 0, -SEPARATOR_PATH.length)\n  }\n\n  return path\n\n}\n\n/**\n * 把结构化数据序列化成 url\n */\nfunction stringifyUrl(path: string, params: Data | void, query: Data | void) {\n\n  if (/\\/\\:\\w+/.test(path)) {\n\n    const terms: string[] = []\n\n    API.array.each(\n      path.split(SEPARATOR_PATH),\n      function (item) {\n        terms.push(\n          API.string.startsWith(item, PREFIX_PARAM) && params\n            ? params[item.substr(PREFIX_PARAM.length)]\n            : item\n        )\n      }\n    )\n\n    path = terms.join(SEPARATOR_PATH)\n\n  }\n\n  if (query) {\n    const queryStr = queryUtil.stringify(API, query)\n    if (queryStr) {\n      path += SEPARATOR_SEARCH + queryStr\n    }\n  }\n\n  return path\n\n}\n\nfunction toUrl(target: Target, name2Path: Data): string {\n\n  if (API.is.string(target)) {\n    return formatPath(target as string)\n  }\n\n  let route = target as RouteTarget, name = route.name, path: string\n  if (name) {\n    path = name2Path[name]\n    if (process.env.NODE_ENV === 'development') {\n      if (!API.is.string(path)) {\n        API.logger.error(`The route of name \"${name}\" is not found.`)\n      }\n    }\n  }\n  else {\n    path = formatPath(route.path as string)\n  }\n\n  return stringifyUrl(path, route.params, route.query)\n\n}\n\n/**\n * 按照 propTypes 定义的外部数据格式过滤路由参数，这样有两个好处：\n *\n * 1. 避免传入不符预期的数据\n * 2. 避免覆盖 data 定义的数据\n */\nfunction filterProps(route: LinkedRoute, location: Location, options: ComponentOptions) {\n  const result: Data = {}, propTypes = options.propTypes\n  if (propTypes) {\n\n    let props = location.query,\n\n    routeParams = route.params,\n\n    locationParams = location.params\n\n    // 从 location.params 挑出 route.params 定义过的参数\n    if (routeParams && locationParams) {\n      props = props ? API.object.copy(props) : {}\n      for (let i = 0, length = routeParams.length; i < length; i++) {\n        (props as Data)[routeParams[i]] = locationParams[routeParams[i]]\n      }\n    }\n\n    if (props) {\n      for (let key in propTypes) {\n        let value = props[key]\n        if (value !== UNDEFINED) {\n          result[key] = value\n        }\n      }\n    }\n\n  }\n  return result\n}\n\n/**\n * 是否是叶子节点\n * 如果把叶子节点放在 if 中，会出现即使不是定义时的叶子节点，却是运行时的叶子节点\n */\nfunction isLeafRoute(route: LinkedRoute) {\n  const child = route.child\n  return !child || !child.context\n}\n\nfunction updateRoute(instance: YoxInterface, componentHookName: string | void, hookName: string | undefined, upsert?: boolean) {\n  const route = instance[ROUTE] as LinkedRoute\n  if (route) {\n    route.context = upsert ? instance : UNDEFINED\n    if (isLeafRoute(route)) {\n      const router = instance[ROUTER] as Router\n      if (componentHookName && hookName) {\n        router.hook(route, componentHookName, hookName)\n      }\n      if (upsert) {\n        const { pending } = router\n        if (pending) {\n          pending.onComplete()\n          router.pending = UNDEFINED\n        }\n      }\n    }\n  }\n}\n\nexport class Router {\n\n  el: Element\n\n  options: RouterOptions\n\n  routes: LinkedRoute[]\n\n  route404: LinkedRoute\n\n  name2Path: Record<string, string>\n\n  path2Route: Record<string, LinkedRoute>\n\n  mode: Mode\n\n  history: Location[]\n\n  cursor: number\n\n  pending?: RoutePending\n\n  // 路由钩子\n  hooks: Hooks\n\n  // 路由或参数发生了变化会触发此函数\n  handler: Function\n\n  // 当前渲染的路由\n  route?: LinkedRoute\n\n  // 当前地址栏的路径和参数\n  location?: Location\n\n  constructor(options: RouterOptions) {\n\n    const instance = this, el = options.el, route404 = options.route404 || default404\n\n    instance.options = options\n\n    instance.el = API.is.string(el)\n      ? API.dom.find(el as string) as Element\n      : el as Element\n\n    if (process.env.NODE_ENV === 'development') {\n      if (!instance.el) {\n        API.logger.error(`The \"el\" option must be an element or a selector.`)\n        return\n      }\n    }\n\n    instance.mode = options.mode === MODE_HISTORY && historyMode.isSupported\n      ? historyMode\n      : hashMode\n\n    instance.handler = function () {\n\n      const url = instance.mode.current(), { pending } = instance\n\n      if (pending) {\n        const { location } = pending\n        // 通过 push 或 go 触发\n        if (location.url === url) {\n          instance.setHistory(location, pending.cursor)\n          instance.setRoute(location)\n          return\n        }\n        instance.pending = UNDEFINED\n      }\n\n      // 直接修改地址栏触发\n      instance.parseLocation(\n        url,\n        function (location) {\n          if (location) {\n            instance.setHistory(location)\n            instance.setRoute(location)\n          }\n          else {\n            instance.push(instance.route404)\n          }\n        }\n      )\n    }\n\n    instance.routes = []\n    instance.name2Path = {}\n    instance.path2Route = {}\n\n    instance.history = []\n    instance.cursor = -1\n\n    instance.hooks = new Hooks()\n\n    API.array.each(\n      options.routes,\n      function (route) {\n        instance.add(route)\n      }\n    )\n\n    instance.route404 = instance.add(route404)[0]\n\n  }\n\n  /**\n   * 添加一个新的路由\n   */\n  add(routeOptions: RouteOptions) {\n\n    const instance = this,\n\n    newRoutes: LinkedRoute[] = [],\n\n    pathStack: string[] = [],\n\n    routeStack: LinkedRoute[] = [],\n\n    addRoute = function (routeOptions: RouteOptions) {\n\n      let { name, component, children, load } = routeOptions,\n\n      parentPath = API.array.last(pathStack),\n\n      parentRoute = API.array.last(routeStack),\n\n      path = formatPath(routeOptions.path, parentPath),\n\n      route: LinkedRoute = { path, route: routeOptions },\n\n      params: string[] = []\n\n      API.array.each(\n        path.split(SEPARATOR_PATH),\n        function (item) {\n          if (API.string.startsWith(item, PREFIX_PARAM)) {\n            params.push(\n              item.substr(PREFIX_PARAM.length)\n            )\n          }\n        }\n      )\n\n      if (params.length) {\n        route.params = params\n      }\n\n      if (name) {\n        route.name = name\n      }\n\n      // component 和 load 二选一\n      if (component) {\n        route.component = component\n      }\n      else if (load) {\n        route.load = load\n      }\n\n      if (parentRoute) {\n        route.parent = parentRoute\n      }\n\n      if (children) {\n        pathStack.push(path)\n        routeStack.push(route)\n        API.array.each(\n          children,\n          addRoute\n        )\n        routeStack.pop()\n        pathStack.pop()\n      }\n      else {\n\n        newRoutes.push(route)\n        instance.routes.push(route)\n\n        if (name) {\n          if (process.env.NODE_ENV === 'development') {\n            if (API.object.has(instance.name2Path, name)) {\n              API.logger.error(`The name \"${name}\" of the route is existed.`)\n              return\n            }\n          }\n          instance.name2Path[name] = path\n        }\n\n        if (process.env.NODE_ENV === 'development') {\n          if (API.object.has(instance.path2Route, path)) {\n            API.logger.error(`The path \"${path}\" of the route is existed.`)\n            return\n          }\n        }\n\n        instance.path2Route[path] = route\n\n      }\n\n    }\n\n    addRoute(routeOptions)\n\n    return newRoutes\n\n  }\n\n  /**\n   * 删除一个已注册的路由\n   */\n  remove(route: LinkedRoute) {\n\n    const instance = this\n\n    API.array.remove(instance.routes, route)\n\n    if (route.name) {\n      delete instance.name2Path[route.name]\n    }\n\n    delete instance.path2Route[route.path]\n\n  }\n\n  /**\n   * target 有 3 种格式：\n   *\n   * 如果只是简单的 path，直接传字符串\n   *\n   * push('/index')\n   *\n   * 如果需要带参数，可传对象\n   *\n   * push({\n   *   path: '/index',\n   *   params: { },\n   *   query: { }\n   * })\n   *\n   * 如果路由配置了 name，可用 name 代替 path，如下：\n   *\n   * push({\n   *   name: 'index'\n   * })\n   *\n   */\n  push(target: Target) {\n\n    const instance = this, { mode } = instance\n\n    instance.setUrl(\n      toUrl(target, instance.name2Path),\n      EMPTY_FUNCTION,\n      EMPTY_FUNCTION,\n      function (location, pending) {\n        instance.pending = pending\n        if (mode.current() !== location.url) {\n          mode.push(location, instance.handler)\n        }\n        else {\n          instance.setRoute(location)\n        }\n      }\n    )\n\n  }\n\n  /**\n   * 不改变 URL，只修改路由组件\n   */\n  replace(target: Target) {\n\n    const instance = this\n\n    instance.setUrl(\n      toUrl(target, instance.name2Path),\n      function () {\n        instance.replaceHistory(instance.location as Location)\n      },\n      EMPTY_FUNCTION,\n      function (location, pending) {\n        instance.pending = pending\n        instance.setRoute(location)\n      }\n    )\n\n  }\n\n  /**\n   * 前进或后退 n 步\n   */\n  go(n: number) {\n\n    const instance = this,\n\n    { mode } = instance,\n\n    cursor = instance.cursor + n,\n\n    location = instance.history[cursor]\n\n    if (location) {\n      instance.setUrl(\n        stringifyUrl(location.path, location.params, location.query),\n        EMPTY_FUNCTION,\n        EMPTY_FUNCTION,\n        function (location, pending) {\n          pending.cursor = cursor\n          instance.pending = pending\n\n          if (mode.current() !== location.url) {\n            mode.go(n)\n          }\n          else {\n            instance.setHistory(location, cursor)\n            instance.setRoute(location)\n          }\n        }\n      )\n    }\n\n  }\n\n  /**\n   * 启动路由\n   */\n  start() {\n    this.mode.start(API.dom, this.handler)\n  }\n\n  /**\n   * 停止路由\n   */\n  stop() {\n    this.mode.stop(API.dom, this.handler)\n  }\n\n  /**\n   * 钩子函数\n   */\n  hook(route: LinkedRoute, componentHook: string, hook: string, isGuard?: boolean, callback?: Function) {\n\n    const instance = this, { location, hooks, pending } = instance\n\n    hooks\n      .clear()\n      // 先调用组件的钩子\n      .add((route.component as ComponentOptions)[componentHook], route.context)\n      // 再调用路由配置的钩子\n      .add(route.route[hook], route.route)\n      // 最后调用路由实例的钩子\n      .add(instance.options[hook], instance)\n\n    const next = function (value?: false | Target) {\n      if (value === UNDEFINED) {\n        hooks.next(next, isGuard, callback)\n      }\n      else {\n        // 只有前置守卫才有可能走进这里\n        // 此时 instance.location 还是旧地址\n        if (pending) {\n          pending.onAbort()\n          instance.pending = UNDEFINED\n        }\n        if (value === FALSE) {\n          if (location) {\n            instance.push(location)\n          }\n        }\n        else {\n          // 跳转到别的路由\n          instance.push(value)\n        }\n      }\n    }\n\n    next()\n\n  }\n\n  private setHistory(location: Location, index: number | void) {\n\n    const { history, cursor } = this\n\n    // 如果没传 cursor，表示 push\n    if (!API.is.number(index)) {\n      index = cursor + 1\n      // 确保下一个为空\n      // 如果不为空，肯定是调用过 go()，此时直接清掉后面的就行了\n      if (history[index]) {\n        history.length = index\n      }\n    }\n\n    history[index as number] = location\n\n    this.cursor = index as number\n\n  }\n\n  private replaceHistory(location: Location) {\n    const { history, cursor } = this\n    if (history[cursor]) {\n      history[cursor] = location\n    }\n  }\n\n  private setUrl(\n    url: string,\n    onComplete: Function,\n    onAbort: Function,\n    callback: (locaiton: Location, pending: RoutePending) => void\n  ) {\n\n    // 这里无需判断新旧 url 是否相同，因为存在 replace，即使它们相同也不等价于不用跳转\n    const instance = this\n\n    instance.parseLocation(\n      url,\n      function (location) {\n\n        if (location) {\n          callback(\n            location,\n            {\n              location,\n              onComplete,\n              onAbort,\n            }\n          )\n        }\n        else if (process.env.NODE_ENV === 'development') {\n          API.logger.error(`The url \"${url}\" can't match a route.`)\n        }\n\n      }\n    )\n\n  }\n\n  private parseLocation(url: string, callback: (location?: Location) => void) {\n\n    let realpath: string, search: string | void, index = url.indexOf(SEPARATOR_SEARCH)\n\n    if (index >= 0) {\n      realpath = url.slice(0, index)\n      search = url.slice(index + 1)\n    }\n    else {\n      realpath = url\n    }\n\n    // 匹配已注册的 route\n    const instance = this,\n\n    realpathTerms = realpath.split(SEPARATOR_PATH),\n\n    length = realpathTerms.length,\n\n    matchRoute = function (\n      routes: LinkedRoute[],\n      callback: (route?: LinkedRoute, params?: Data) => void\n    ) {\n\n      let index = 0, route: LinkedRoute | void\n\n      loop: while (route = routes[index++]) {\n        const path = route.path\n\n        // 动态路由\n        if (route.params) {\n          const pathTerms = path.split(SEPARATOR_PATH)\n          // path 段数量必须一致，否则没有比较的意义\n          if (length === pathTerms.length) {\n            const params: Data = {}\n            for (let i = 0; i < length; i++) {\n              if (API.string.startsWith(pathTerms[i], PREFIX_PARAM)) {\n                params[pathTerms[i].substr(PREFIX_PARAM.length)] = valueUtil.parse(API, realpathTerms[i])\n              }\n              // 非参数段不相同\n              else if (pathTerms[i] !== realpathTerms[i]) {\n                continue loop\n              }\n            }\n            callback(route, params)\n            return\n          }\n        }\n        // 懒加载路由，前缀匹配成功后，意味着懒加载回来的路由一定有我们想要的\n        else if (route.load && API.string.startsWith(realpath, path)) {\n          const routeCallback: RouteCallback = function (lazyRoute) {\n            instance.remove(route as LinkedRoute)\n            matchRoute(\n              instance.add(lazyRoute['default'] || lazyRoute),\n              callback\n            )\n          }\n          const promise = route.load(routeCallback)\n          if (promise) {\n            promise.then(routeCallback)\n          }\n          return\n        }\n        else if (path === realpath) {\n          callback(route)\n          return\n        }\n      }\n\n      callback()\n\n    }\n\n    matchRoute(\n      instance.routes,\n      function (route, params) {\n        if (route) {\n          const location: Location = {\n            url,\n            path: route.path\n          }\n          if (params) {\n            location.params = params\n          }\n          if (search) {\n            const query = queryUtil.parse(API, search)\n            if (query) {\n              location.query = query\n            }\n          }\n          callback(location)\n        }\n        else {\n          callback()\n        }\n      }\n    )\n\n  }\n\n  private diffRoute(\n    route: LinkedRoute,\n    oldRoute: LinkedRoute | void,\n    onComplete: (route: LinkedRoute, startRoute: LinkedRoute | void) => void,\n    startRoute: LinkedRoute | void,\n    childRoute: LinkedRoute | void,\n    oldTopRoute: LinkedRoute | void\n  ) {\n\n    // 更新链路\n    if (childRoute) {\n      route.child = childRoute\n      childRoute.parent = route\n    }\n\n    if (oldRoute) {\n      // 同级的两个组件不同，疑似起始更新的路由\n      if (oldRoute.component !== route.component) {\n        startRoute = route\n      }\n      else {\n        // 把上次的组件实例搞过来\n        route.context = oldRoute.context\n      }\n    }\n    else {\n      startRoute = route\n    }\n\n    if (route.parent) {\n      this.diffRoute(\n        API.object.copy(route.parent),\n        oldRoute ? oldRoute.parent : UNDEFINED,\n        onComplete,\n        startRoute,\n        route,\n        oldRoute || oldTopRoute\n      )\n      return\n    }\n\n    // 整个组件树全换掉\n    if (startRoute === route) {\n      let context: YoxInterface | void\n      // 当层级较多的路由切换到层级较少的路由\n      if (oldRoute) {\n        while (oldRoute) {\n          context = oldRoute.context\n          oldRoute = oldRoute.parent\n        }\n      }\n      // 当层级较少的路由切换到层级较多的路由\n      else if (oldTopRoute) {\n        context = oldTopRoute.context\n      }\n      if (context) {\n        startRoute.context = context\n      }\n    }\n\n    // 到达根组件，结束\n    onComplete(route, startRoute)\n\n  }\n\n  private patchRoute(\n    route: LinkedRoute,\n    startRoute: LinkedRoute | void\n  ) {\n\n    const instance = this, location = instance.location as Location\n\n    // 从上往下更新 props\n    while (route) {\n\n      let { parent, context, component } = route\n\n      if (route === startRoute) {\n\n        if (parent) {\n\n          context = parent.context as YoxInterface\n          context.forceUpdate(\n            filterProps(\n              parent,\n              location,\n              parent.component as ComponentOptions\n            )\n          )\n\n          context = context[ROUTE_VIEW]\n          if (context) {\n            const props = {}, name = ROUTE_COMPONENT + (++guid)\n            props[ROUTE_COMPONENT] = name\n            context.component(name, component)\n            context.forceUpdate(props)\n          }\n\n        }\n        else {\n\n          if (context) {\n            context.destroy()\n          }\n\n          // 每层路由组件都有 $route 和 $router 属性\n          const extensions = {}\n          extensions[ROUTER] = instance\n          extensions[ROUTE] = route\n\n          const options: ComponentOptions = API.object.extend(\n            {\n              el: instance.el,\n              props: filterProps(route, location, component as ComponentOptions),\n              extensions,\n            },\n            component as ComponentOptions\n          )\n\n          options.events = options.events\n            ? API.object.extend(options.events, hookEvents)\n            : hookEvents\n\n          route.context = new API(options)\n\n        }\n\n      }\n\n      else if (context) {\n        if (context.$vnode) {\n          context[ROUTE] = route\n          context.forceUpdate(\n            filterProps(route, location, component as ComponentOptions)\n          )\n        }\n        else {\n          route.context = UNDEFINED\n        }\n        if (route.child) {\n          route = route.child as LinkedRoute\n          continue\n        }\n      }\n      break\n    }\n  }\n\n  private setRoute(location: Location) {\n\n    let instance = this,\n\n    linkedRoute = instance.path2Route[location.path],\n\n    redirect = linkedRoute.route.redirect\n\n    if (redirect) {\n      if (API.is.func(redirect)) {\n        redirect = (redirect as Redirect)(location)\n      }\n      if (redirect) {\n        instance.push(redirect as Target)\n        return\n      }\n    }\n\n    const newRoute = API.object.copy(linkedRoute),\n\n    oldRoute = instance.route,\n\n    oldLocation = instance.location,\n\n    enterRoute = function () {\n      instance.diffRoute(\n        newRoute,\n        oldRoute,\n        function (route, startRoute) {\n          instance.hook(\n            newRoute,\n            startRoute ? HOOK_BEFORE_ROUTE_ENTER : HOOK_BEFORE_ROUTE_UPDATE,\n            startRoute ? ROUTER_HOOK_BEFORE_ENTER : ROUTER_HOOK_BEFORE_UPDATE,\n            TRUE,\n            function () {\n\n              instance.route = newRoute\n              instance.location = location\n\n              instance.patchRoute(route, startRoute)\n\n            }\n          )\n        }\n      )\n    }\n\n    instance.hooks.setLocation(location, oldLocation)\n\n    if (oldRoute && oldLocation && location.path !== oldLocation.path) {\n      instance.hook(\n        oldRoute,\n        HOOK_BEFORE_ROUTE_LEAVE,\n        ROUTER_HOOK_BEFORE_LEAVE,\n        TRUE,\n        enterRoute\n      )\n      return\n    }\n\n    enterRoute()\n\n  }\n\n}\n\nconst default404 = {\n  path: '/404',\n  component: {\n    template: '<div>This is a default 404 page, please set \"route404\" for your own 404 page.</div>'\n  }\n},\n\ndirective = {\n  bind(node: HTMLElement | YoxInterface, directive: Directive, vnode: VNode) {\n\n    // 当前组件如果是根组件，则没有 $root 属性\n    const $root = vnode.context.$root || vnode.context,\n\n    router = $root[ROUTER] as Router,\n\n    listener = vnode.data[directive.key] = function (_: CustomEventInterface) {\n      let { value, getter } = directive, target: any = value\n      if (value && getter && API.string.has(value as string, '{')) {\n        target = getter()\n      }\n      router[directive.name](target)\n    }\n\n    if (vnode.isComponent) {\n      (node as YoxInterface).on(EVENT_CLICK, listener)\n    }\n    else {\n      API.dom.on(node as HTMLElement, EVENT_CLICK, listener)\n    }\n\n  },\n  unbind(node: HTMLElement | YoxInterface, directive: Directive, vnode: VNode) {\n    const listener = vnode.data[directive.key]\n    if (vnode.isComponent) {\n      (node as YoxInterface).off(EVENT_CLICK, listener)\n    }\n    else {\n      API.dom.off(node as HTMLElement, EVENT_CLICK, listener)\n    }\n  },\n},\n\nRouterView: ComponentOptions = {\n  template: '<$' + ROUTE_COMPONENT + '/>',\n  beforeCreate(options) {\n\n    const context = options.context as YoxInterface,\n\n    route = context[ROUTE].child as LinkedRoute\n\n    if (route) {\n\n      context[ROUTE_VIEW] = this\n\n      const props = options.props = {}, components = options.components = {},\n\n      name = ROUTE_COMPONENT + (++guid)\n\n      props[ROUTE_COMPONENT] = name\n      components[name] = route.component\n\n    }\n\n  },\n  beforeDestroy() {\n    this.$context[ROUTE_VIEW] = UNDEFINED\n  }\n}\n\n/**\n * 版本\n */\nexport const version = process.env.NODE_VERSION\n\n/**\n * 安装插件\n */\nexport function install(Yox: API): void {\n\n  API = Yox\n\n  Yox.directive({\n    push: directive,\n    replace: directive,\n    go: directive,\n  })\n\n  Yox.component('router-view', RouterView)\n\n  hookEvents = {\n    'beforeCreate.hook': function (event: CustomEventInterface, data?: Data) {\n      if (data) {\n        let options = data as ComponentOptions, { context } = options\n        // 当前组件是 <router-view> 中的动态组件\n        if (context && context.$options.beforeCreate === RouterView.beforeCreate) {\n          // 找到渲染 <router-view> 的父级组件，它是一定存在的\n          context = context.$context as YoxInterface\n\n          const router = context[ROUTER] as Router,\n          route = context[ROUTE].child as LinkedRoute\n\n          if (route) {\n            const extensions = options.extensions = {}\n            extensions[ROUTER] = router\n            extensions[ROUTE] = route\n\n            if (router.location) {\n              options.props = filterProps(route, router.location, options)\n            }\n          }\n        }\n      }\n    },\n    'afterMount.hook': function (event: CustomEventInterface) {\n      updateRoute(\n        event.target as YoxInterface,\n        HOOK_AFTER_ROUTE_ENTER,\n        ROUTER_HOOK_AFTER_ENTER,\n        TRUE\n      )\n    },\n    'afterUpdate.hook': function (event: CustomEventInterface) {\n      updateRoute(\n        event.target as YoxInterface,\n        HOOK_AFTER_ROUTE_UPDATE,\n        ROUTER_HOOK_AFTER_UPDATE,\n        TRUE\n      )\n    },\n    'afterDestroy.hook': function (event: CustomEventInterface) {\n      updateRoute(\n        event.target as YoxInterface,\n        HOOK_AFTER_ROUTE_LEAVE,\n        ROUTER_HOOK_AFTER_LEAVE\n      )\n    }\n  }\n\n}\n","import {\n  API,\n} from '../type'\n\nimport {\n  SEPARATOR_QUERY,\n  SEPARATOR_PAIR,\n  FLAG_ARRAY,\n} from '../constant'\n\nimport * as valueUtil from './value'\n\n/**\n * 把 GET 参数解析成对象\n */\nexport function parse(API: API, query: string) {\n  let result: object | undefined\n  API.array.each(\n    query.split(SEPARATOR_QUERY),\n    function (term) {\n\n      let terms = term.split(SEPARATOR_PAIR),\n\n      key = API.string.trim(terms[0]),\n\n      value = terms[1]\n\n      if (key) {\n        if (!result) {\n          result = {}\n        }\n        value = valueUtil.parse(API, value)\n        if (API.string.endsWith(key, FLAG_ARRAY)) {\n          key = API.string.slice(key, 0, -FLAG_ARRAY.length)\n          API.array.push(\n            result[key] || (result[key] = []),\n            value\n          )\n        }\n        else {\n          result[key] = value\n        }\n      }\n\n    }\n  )\n  return result\n}\n\n/**\n * 把对象解析成 key1=value1&key2=value2\n */\nexport function stringify(API: API, query: object) {\n  const result: string[] = []\n  for (let key in query) {\n    const value = query[key]\n    if (API.is.array(value)) {\n      API.array.each(\n        value,\n        function (value) {\n          const str = valueUtil.stringify(API, value)\n          if (API.is.string(str)) {\n            result.push(\n              key + FLAG_ARRAY + SEPARATOR_PAIR + str\n            )\n          }\n        }\n      )\n    }\n    else {\n      const str = valueUtil.stringify(API, value)\n      if (API.is.string(str)) {\n        result.push(\n          key + SEPARATOR_PAIR + str\n        )\n      }\n    }\n  }\n  return result.join(SEPARATOR_QUERY)\n}\n"],"names":["WINDOW","window","LOCATION","location","HISTORY","history","UNDEFINED","NULL","TRUE","FALSE","RAW_NULL","RAW_TRUE","RAW_FALSE","PREFIX_PARAM","SEPARATOR_PATH","SEPARATOR_SEARCH","SEPARATOR_QUERY","SEPARATOR_PAIR","FLAG_ARRAY","MODE_HISTORY","ROUTER_HOOK_BEFORE_ENTER","ROUTER_HOOK_AFTER_ENTER","ROUTER_HOOK_BEFORE_UPDATE","ROUTER_HOOK_AFTER_UPDATE","ROUTER_HOOK_BEFORE_LEAVE","ROUTER_HOOK_AFTER_LEAVE","HOOK_BEFORE_ROUTE_ENTER","HOOK_AFTER_ROUTE_ENTER","HOOK_BEFORE_ROUTE_UPDATE","HOOK_AFTER_ROUTE_UPDATE","HOOK_BEFORE_ROUTE_LEAVE","HOOK_AFTER_ROUTE_LEAVE","Hooks","[object Object]","to","from","this","list","hook","ctx","push","fn","next","isGuard","callback","task","shift","call","parse","API","value","result","is","numeric","string","decodeURIComponent","stringify","encodeURIComponent","number","boolean","toString","HASH_PREFIX","HASH_CHANGE","api","handler","on","off","hash","url","n","go","href","index","indexOf","substr","length","POP_STATE","isSupported","pushState","pathname","search","hookEvents","guid","ROUTER","ROUTE","ROUTE_VIEW","ROUTE_COMPONENT","EMPTY_FUNCTION","Function","formatPath","path","parentPath","startsWith","endsWith","slice","stringifyUrl","params","query","test","terms","array","each","split","item","join","queryStr","key","str","valueUtil.stringify","queryUtil.stringify","toUrl","target","name2Path","route","name","filterProps","options","propTypes","props","routeParams","locationParams","object","copy","i","updateRoute","instance","componentHookName","hookName","upsert","context","child","isLeafRoute","router","pending","onComplete","Router","el","route404","default404","dom","find","mode","historyMode.isSupported","historyMode","hashMode","current","setHistory","cursor","setRoute","parseLocation","routes","path2Route","hooks","add","routeOptions","newRoutes","pathStack","routeStack","addRoute","component","children","load","last","parentRoute","parent","pop","remove","setUrl","replaceHistory","start","stop","componentHook","clear","onAbort","realpath","realpathTerms","matchRoute","loop","pathTerms","valueUtil.parse","routeCallback","lazyRoute","promise","then","term","trim","queryUtil.parse","oldRoute","startRoute","childRoute","oldTopRoute","diffRoute","forceUpdate","destroy","extensions","extend","events","$vnode","linkedRoute","redirect","func","newRoute","oldLocation","enterRoute","patchRoute","setLocation","template","directive","node","vnode","$root","listener","data","_","getter","has","isComponent","RouterView","components","$context","version","install","Yox","replace","beforeCreate.hook","event","$options","beforeCreate","afterMount.hook","afterUpdate.hook","afterDestroy.hook"],"mappings":"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"}