{"version":3,"file":"yox-router.min.js","sources":["../../yox-config/src/config.ts","../../yox-common/src/util/env.ts","../src/Hooks.ts","../src/constant.ts","../src/util/value.ts","../src/mode/hash.ts","../src/mode/history.ts","../src/Router.ts","../src/util/query.ts"],"sourcesContent":["export const SYNTAX_IF = '#if'\nexport const SYNTAX_ELSE = 'else'\nexport const SYNTAX_ELSE_IF = 'else if'\nexport const SYNTAX_EACH = '#each'\nexport const SYNTAX_PARTIAL = '#partial'\nexport const SYNTAX_IMPORT = '>'\nexport const SYNTAX_SPREAD = '...'\nexport const SYNTAX_COMMENT = /^!\\s/\n\nexport const SLOT_DATA_PREFIX = '$slot_'\nexport const SLOT_NAME_DEFAULT = 'children'\n\nexport const HINT_STRING = 1\nexport const HINT_NUMBER = 2\nexport const HINT_BOOLEAN = 3\n\nexport const DIRECTIVE_ON = 'on'\nexport const DIRECTIVE_LAZY = 'lazy'\nexport const DIRECTIVE_MODEL = 'model'\nexport const DIRECTIVE_EVENT = 'event'\nexport const DIRECTIVE_BINDING = 'binding'\nexport const DIRECTIVE_CUSTOM = 'o'\n\nexport const MODEL_PROP_DEFAULT = 'value'\n\nexport const HOOK_BEFORE_CREATE = 'beforeCreate'\nexport const HOOK_AFTER_CREATE = 'afterCreate'\nexport const HOOK_BEFORE_MOUNT = 'beforeMount'\nexport const HOOK_AFTER_MOUNT = 'afterMount'\nexport const HOOK_BEFORE_UPDATE = 'beforeUpdate'\nexport const HOOK_AFTER_UPDATE = 'afterUpdate'\nexport const HOOK_BEFORE_DESTROY = 'beforeDestroy'\nexport const HOOK_AFTER_DESTROY = 'afterDestroy'\n\n// 路由钩子\nexport const HOOK_BEFORE_ROUTE_ENTER = 'beforeRouteEnter'\nexport const HOOK_AFTER_ROUTE_ENTER = 'afterRouteEnter'\nexport const HOOK_BEFORE_ROUTE_UPDATE = 'beforeRouteUpdate'\nexport const HOOK_AFTER_ROUTE_UPDATE = 'afterRouteUpdate'\nexport const HOOK_BEFORE_ROUTE_LEAVE = 'beforeRouteLeave'\nexport const HOOK_AFTER_ROUTE_LEAVE = 'afterRouteLeave'\n","/**\n * 为了压缩，定义的常量\n */\nexport const TRUE = true\nexport const FALSE = false\nexport const NULL = null\nexport const UNDEFINED = void 0\n\nexport const RAW_TRUE = 'true'\nexport const RAW_FALSE = 'false'\nexport const RAW_NULL = 'null'\nexport const RAW_UNDEFINED = 'undefined'\n\nexport const RAW_KEY = 'key'\nexport const RAW_REF = 'ref'\nexport const RAW_SLOT = 'slot'\nexport const RAW_NAME = 'name'\n\nexport const RAW_FILTER = 'filter'\nexport const RAW_PARTIAL = 'partial'\nexport const RAW_COMPONENT = 'component'\nexport const RAW_DIRECTIVE = 'directive'\nexport const RAW_TRANSITION = 'transition'\n\nexport const RAW_THIS = 'this'\nexport const RAW_VALUE = 'value'\nexport const RAW_LENGTH = 'length'\nexport const RAW_FUNCTION = 'function'\nexport const RAW_TEMPLATE = 'template'\nexport const RAW_WILDCARD = '*'\n\nexport const KEYPATH_PARENT = '..'\nexport const KEYPATH_CURRENT = RAW_THIS\n\nexport const RAW_MINUS_ONE = -1\n\n/**\n * Single instance for window in browser\n */\nexport const WINDOW = typeof window !== RAW_UNDEFINED ? window : UNDEFINED\n\n/**\n * Single instance for document in browser\n */\nexport const DOCUMENT = typeof document !== RAW_UNDEFINED ? document : UNDEFINED\n\n/**\n * tap 事件\n *\n * 非常有用的抽象事件，比如 pc 端是 click 事件，移动端是 touchend 事件\n *\n * 这样只需 on-tap=\"handler\" 就可以完美兼容各端\n *\n * 框架未实现此事件，通过 Yox.dom.specialEvents 提供给外部扩展\n *\n */\nexport const EVENT_TAP = 'tap'\n\n/**\n * 点击事件\n */\nexport const EVENT_CLICK = 'click'\n\n/**\n * 输入事件\n */\nexport const EVENT_INPUT = 'input'\n\n/**\n * 变化事件\n */\nexport const EVENT_CHANGE = 'change'\n\n/**\n * 唯一内置的特殊事件：model\n */\nexport const EVENT_MODEL = 'model'\n\n/**\n * Single instance for noop function\n */\nexport const EMPTY_FUNCTION = function () {\n  /** yox */\n}\n\n/**\n * 空对象，很多地方会用到，比如 `a || EMPTY_OBJECT` 确保是个对象\n */\nexport const EMPTY_OBJECT = Object.freeze({})\n\n/**\n * 空数组\n */\nexport const EMPTY_ARRAY = Object.freeze([])\n\n/**\n * 空字符串\n */\nexport const EMPTY_STRING = ''\n","import Task from '../../yox-type/src/interface/Task'\nimport Location from '../../yox-type/src/router/Location'\n\nimport * as type from './type'\n\nexport default class Hooks {\n\n  list: Task[]\n\n  to: Location\n\n  from: Location | void\n\n  setLocation(to: Location, from: Location | void) {\n    this.to = to\n    this.from = from\n    return this\n  }\n\n  clear() {\n    this.list = []\n    return this\n  }\n\n  add(hook: Function | void, ctx: any) {\n    const { list } = this\n    if (hook) {\n      list.push({\n        fn: hook,\n        ctx,\n      })\n    }\n    return this\n  }\n\n  next(next: Function, isGuard?: boolean, callback?: type.Callback) {\n    const task = this.list.shift()\n    if (task) {\n      if (isGuard) {\n        task.fn.call(task.ctx, this.to, this.from, next)\n      }\n      else {\n        task.fn.call(task.ctx, this.to, this.from)\n        next()\n      }\n    }\n    else if (callback) {\n      callback()\n    }\n  }\n\n}","export const WINDOW = window\n\nexport const LOCATION = WINDOW.location\nexport const HISTORY = WINDOW.history\n\n// path 中的参数前缀，如 /user/:userId\nexport const PREFIX_PARAM = ':'\n\n// path 分隔符\nexport const SEPARATOR_PATH = '/'\n\n// path 和 search 的分隔符\nexport const SEPARATOR_SEARCH = '?'\n\n// query 分隔符\nexport const SEPARATOR_QUERY = '&'\n\n// 键值对分隔符\nexport const SEPARATOR_PAIR = '='\n\n// 参数中的数组标识\nexport const FLAG_ARRAY = '[]'\n\n// 导航钩子 - 路由进入之前\nexport const HOOK_BEFORE_ENTER = 'beforeEnter'\n\n// 导航钩子 - 路由进入之后\nexport const HOOK_AFTER_ENTER = 'afterEnter'\n\n// 导航钩子 - 路由更新之前\nexport const HOOK_BEFORE_UPDATE = 'beforeUpdate'\n\n// 导航钩子 - 路由更新之后\nexport const HOOK_AFTER_UPDATE = 'afterUpdate'\n\n// 导航钩子 - 路由离开之前\nexport const HOOK_BEFORE_LEAVE = 'beforeLeave'\n\n// 导航钩子 - 路由离开之后\nexport const HOOK_AFTER_LEAVE = 'afterLeave'","import * as env from '../../../yox-common/src/util/env'\nimport YoxClass from '../../../yox-type/src/interface/YoxClass'\n\n/**\n * 把字符串 value 解析成最合适的类型\n */\nexport function parse(Yox: YoxClass, value: string) {\n  let result: any\n  if (Yox.is.numeric(value)) {\n    result = +value\n  }\n  else if (Yox.is.string(value)) {\n    if (value === env.RAW_TRUE) {\n      result = env.TRUE\n    }\n    else if (value === env.RAW_FALSE) {\n      result = env.FALSE\n    }\n    else if (value === env.RAW_NULL) {\n      result = env.NULL\n    }\n    else {\n      result = decodeURIComponent(value)\n    }\n  }\n  return result\n}\n\nexport function stringify(Yox: YoxClass, value: any): string | void {\n  if (Yox.is.string(value)) {\n    return encodeURIComponent(value)\n  }\n  else if (Yox.is.number(value) || Yox.is.boolean(value)) {\n    return value.toString()\n  }\n  else if (value === env.NULL) {\n    return env.RAW_NULL\n  }\n}","import * as type from '../../../yox-type/src/type'\n\nimport API from '../../../yox-type/src/interface/API'\nimport Location from '../../../yox-type/src/router/Location'\n\nimport * as constant from '../constant'\n\n// hash 前缀，Google 的规范是 #! 开头，如 #!/path/sub?key=value\nconst HASH_PREFIX = '#!',\n\nHASH_CHANGE = 'hashchange'\n\nexport function start(domApi: API, handler: Function) {\n  domApi.on(constant.WINDOW, HASH_CHANGE, handler as type.listener)\n  handler()\n}\n\nexport function stop(domApi: API, handler: Function) {\n  domApi.off(constant.WINDOW, HASH_CHANGE, handler as type.listener)\n}\n\nexport function push(location: Location, handler: Function) {\n  constant.LOCATION.hash = HASH_PREFIX + location.url\n}\n\nexport function go(n: number) {\n  constant.HISTORY.go(n)\n}\n\nexport function current() {\n\n  // 不能直接读取 window.location.hash\n  // 因为 Firefox 会做 pre-decode\n  const href = constant.LOCATION.href, index = href.indexOf(HASH_PREFIX)\n\n  return index > 0\n    ? href.substr(index + HASH_PREFIX.length)\n    : constant.SEPARATOR_PATH\n\n}\n","import * as type from '../../../yox-type/src/type'\n\nimport API from '../../../yox-type/src/interface/API'\nimport Location from '../../../yox-type/src/router/Location'\n\nimport * as constant from '../constant'\n\nconst POP_STATE = 'popstate'\n\nexport const isSupported = 'pushState' in constant.HISTORY\n\nexport function start(domApi: API, handler: Function) {\n  domApi.on(constant.WINDOW, POP_STATE, handler as type.listener)\n  handler()\n}\n\nexport function stop(domApi: API, handler: Function) {\n  domApi.off(constant.WINDOW, POP_STATE, handler as type.listener)\n}\n\nexport function push(location: Location, handler: Function) {\n  // 调用 pushState 不会触发 popstate 事件\n  // 因此这里需要手动调用一次 handler\n  constant.HISTORY.pushState({}, '', location.url)\n  handler()\n}\n\nexport function go(n: number) {\n  constant.HISTORY.go(n)\n}\n\nexport function current() {\n  return constant.LOCATION.pathname + constant.LOCATION.search\n}\n","import * as config from '../../yox-config/src/config'\nimport * as type from '../../yox-type/src/type'\nimport * as routerType from './type'\n\nimport API from '../../yox-type/src/interface/API'\nimport Yox from '../../yox-type/src/interface/Yox'\nimport YoxClass from '../../yox-type/src/interface/YoxClass'\n\nimport YoxOptions from '../../yox-type/src/options/Yox'\nimport VNode from '../../yox-type/src/vnode/VNode'\nimport Directive from '../../yox-type/src/vnode/Directive'\nimport CustomEvent from '../../yox-type/src/event/CustomEvent'\n\nimport Location from '../../yox-type/src/router/Location'\nimport RouteTarget from '../../yox-type/src/router/RouteTarget'\n\nimport * as env from '../../yox-common/src/util/env'\n\nimport Hooks from './Hooks'\nimport * as constant from './constant'\nimport * as queryUtil from './util/query'\nimport * as valueUtil from './util/value'\n\nimport * as hashMode from './mode/hash'\nimport * as historyMode from './mode/history'\n\nlet Yox: YoxClass, domApi: API, guid = 0\n\nconst ROUTER = '$router',\n\nROUTE = '$route',\n\nROUTE_VIEW = '$routeView',\n\nROUTE_COMPONENT = 'RouteComponent',\n\nEVENT_CLICK = 'click'\n\n/**\n * 格式化路径，确保它以 / 开头，不以 / 结尾\n */\nfunction formatPath(path: string, parentPath: string | void) {\n\n  // 如果不是 / 开头，表示是相对路径\n  if (!Yox.string.startsWith(path, constant.SEPARATOR_PATH)) {\n    // 确保 parentPath 以 / 结尾\n    if (parentPath) {\n      if (!Yox.string.endsWith(parentPath, constant.SEPARATOR_PATH)) {\n        parentPath += constant.SEPARATOR_PATH\n      }\n    }\n    else {\n      parentPath = constant.SEPARATOR_PATH\n    }\n    path = parentPath + path\n  }\n\n  // 如果 path 以 / 结尾，删掉它\n  if (path !== constant.SEPARATOR_PATH\n    && Yox.string.endsWith(path, constant.SEPARATOR_PATH)\n  ) {\n    path = Yox.string.slice(path, 0, -constant.SEPARATOR_PATH.length)\n  }\n\n  return path\n\n}\n\n/**\n * 把结构化数据序列化成 url\n */\nfunction stringifyUrl(path: string, params: type.data | void, query: type.data | void) {\n\n  if (/\\/\\:\\w+/.test(path)) {\n\n    const terms: string[] = []\n\n    Yox.array.each(\n      path.split(constant.SEPARATOR_PATH),\n      function (item) {\n        terms.push(\n          Yox.string.startsWith(item, constant.PREFIX_PARAM) && params\n            ? params[item.substr(constant.PREFIX_PARAM.length)]\n            : item\n        )\n      }\n    )\n\n    path = terms.join(constant.SEPARATOR_PATH)\n\n  }\n\n  if (query) {\n    const queryStr = queryUtil.stringify(Yox, query)\n    if (queryStr) {\n      path += constant.SEPARATOR_SEARCH + queryStr\n    }\n  }\n\n  return path\n\n}\n\nfunction toUrl(target: routerType.Target, name2Path: type.data): string {\n\n  if (Yox.is.string(target)) {\n    return formatPath(target as string)\n  }\n\n  let route = target as RouteTarget, name = route.name, path: string\n  if (name) {\n    path = name2Path[name]\n    if (process.env.NODE_ENV === 'development') {\n      if (!Yox.is.string(path)) {\n        Yox.logger.error(`The route of name[${name}] is not found.`)\n      }\n    }\n  }\n  else {\n    path = formatPath(route.path as string)\n  }\n\n  return stringifyUrl(path, route.params, route.query)\n\n}\n\n/**\n * 按照 propTypes 定义的外部数据格式过滤路由参数，这样有两个好处：\n *\n * 1. 避免传入不符预期的数据\n * 2. 避免覆盖 data 定义的数据\n */\nfunction filterProps(route: routerType.LinkedRoute, location: Location, options: YoxOptions) {\n  const result: type.data = {}, propTypes = options.propTypes\n  if (propTypes) {\n\n    let props = location.query,\n\n    routeParams = route.params,\n\n    locationParams = location.params\n\n    // 从 location.params 挑出 route.params 定义过的参数\n    if (routeParams && locationParams) {\n      props = props ? Yox.object.copy(props) : {}\n      for (let i = 0, length = routeParams.length; i < length; i++) {\n        (props as type.data)[routeParams[i]] = locationParams[routeParams[i]]\n      }\n    }\n\n    if (props) {\n      for (let key in propTypes) {\n        let value = props[key]\n        if (value !== env.UNDEFINED) {\n          result[key] = value\n        }\n      }\n    }\n\n  }\n  return result\n}\n\n/**\n * 是否是叶子节点\n * 如果把叶子节点放在 if 中，会出现即使不是定义时的叶子节点，却是运行时的叶子节点\n */\nfunction isLeafRoute(route: routerType.LinkedRoute) {\n  const child = route.child\n  return !child || !child.context\n}\n\nfunction updateRoute(instance: Yox, hook: Function | void, componentHookName: string | void, hookName: string | undefined, upsert?: boolean) {\n  if (hook) {\n    hook(instance)\n  }\n  const route = instance[ROUTE] as routerType.LinkedRoute\n  if (route) {\n    route.context = upsert ? instance : env.UNDEFINED\n    if (isLeafRoute(route)) {\n      const router = instance[ROUTER] as Router\n      if (componentHookName && hookName) {\n        router.hook(route, componentHookName, hookName)\n      }\n      if (upsert) {\n        const { pending } = router\n        if (pending) {\n          pending.onComplete()\n          router.pending = env.UNDEFINED\n        }\n      }\n    }\n  }\n}\n\nexport class Router {\n\n  el: Element\n\n  options: routerType.RouterOptions\n\n  routes: routerType.LinkedRoute[]\n\n  route404: routerType.LinkedRoute\n\n  name2Path: Record<string, string>\n\n  path2Route: Record<string, routerType.LinkedRoute>\n\n  mode: typeof hashMode\n\n  history: Location[]\n\n  cursor: number\n\n  pending?: routerType.Pending\n\n  // 路由钩子\n  hooks: Hooks\n\n  // 路由或参数发生了变化会触发此函数\n  handler: Function\n\n  // 当前渲染的路由\n  route?: routerType.LinkedRoute\n\n  // 当前地址栏的路径和参数\n  location?: Location\n\n  constructor(options: routerType.RouterOptions) {\n\n    const instance = this, el = options.el, route404 = options.route404 || default404\n\n    instance.options = options\n\n    instance.el = Yox.is.string(el)\n      ? domApi.find(el as string) as Element\n      : el as Element\n\n    if (process.env.NODE_ENV === 'development') {\n      if (!instance.el) {\n        Yox.logger.error(`router.el is not an element.`)\n        return\n      }\n    }\n\n    instance.mode = options.mode === 'history' && historyMode.isSupported ? historyMode : hashMode\n\n    instance.handler = function () {\n\n      const url = instance.mode.current(), { pending } = instance\n\n      if (pending) {\n        const { location } = pending\n        // 通过 push 或 go 触发\n        if (location.url === url) {\n          instance.setHistory(location, pending.cursor)\n          instance.setRoute(location)\n          return\n        }\n        instance.pending = env.UNDEFINED\n      }\n\n      // 直接修改地址栏触发\n      instance.parseLocation(\n        url,\n        function (location) {\n          if (location) {\n            instance.setHistory(location)\n            instance.setRoute(location)\n          }\n          else {\n            instance.push(instance.route404)\n          }\n        }\n      )\n    }\n\n    instance.routes = []\n    instance.name2Path = {}\n    instance.path2Route = {}\n\n    instance.history = []\n    instance.cursor = -1\n\n    instance.hooks = new Hooks()\n\n    Yox.array.each(\n      options.routes,\n      function (route) {\n        instance.add(route)\n      }\n    )\n\n    instance.route404 = instance.add(route404)[0]\n\n  }\n\n  /**\n   * 添加一个新的路由\n   */\n  add(routeOptions: routerType.RouteOptions) {\n\n    const instance = this,\n\n    newRoutes: routerType.LinkedRoute[] = [],\n\n    pathStack: string[] = [],\n\n    routeStack: routerType.LinkedRoute[] = [],\n\n    addRoute = function (routeOptions: routerType.RouteOptions) {\n\n      let { name, component, children, load } = routeOptions,\n\n      parentPath = Yox.array.last(pathStack),\n\n      parentRoute = Yox.array.last(routeStack),\n\n      path = formatPath(routeOptions.path, parentPath),\n\n      route: routerType.LinkedRoute = { path, route: routeOptions },\n\n      params: string[] = []\n\n      Yox.array.each(\n        path.split(constant.SEPARATOR_PATH),\n        function (item) {\n          if (Yox.string.startsWith(item, constant.PREFIX_PARAM)) {\n            params.push(\n              item.substr(constant.PREFIX_PARAM.length)\n            )\n          }\n        }\n      )\n\n      if (params.length) {\n        route.params = params\n      }\n\n      if (name) {\n        route.name = name\n      }\n\n      // component 和 load 二选一\n      if (component) {\n        route.component = component\n      }\n      else if (load) {\n        route.load = load\n      }\n\n      if (parentRoute) {\n        route.parent = parentRoute\n      }\n\n      if (children) {\n        pathStack.push(path)\n        routeStack.push(route)\n        Yox.array.each(\n          children,\n          addRoute\n        )\n        routeStack.pop()\n        pathStack.pop()\n      }\n      else {\n\n        newRoutes.push(route)\n        instance.routes.push(route)\n\n        if (name) {\n          if (process.env.NODE_ENV === 'development') {\n            if (Yox.object.has(instance.name2Path, name)) {\n              Yox.logger.error(`Name[${name}] of the route is existed.`)\n              return\n            }\n          }\n          instance.name2Path[name] = path\n        }\n\n        if (process.env.NODE_ENV === 'development') {\n          if (Yox.object.has(instance.path2Route, path)) {\n            Yox.logger.error(`path [${path}] of the route is existed.`)\n            return\n          }\n        }\n\n        instance.path2Route[path] = route\n\n      }\n\n    }\n\n    addRoute(routeOptions)\n\n    return newRoutes\n\n  }\n\n  /**\n   * 删除一个已注册的路由\n   */\n  remove(route: routerType.LinkedRoute) {\n\n    const instance = this\n\n    Yox.array.remove(instance.routes, route)\n\n    if (route.name) {\n      delete instance.name2Path[route.name]\n    }\n\n    delete instance.path2Route[route.path]\n\n  }\n\n  /**\n   * target 有 3 种格式：\n   *\n   * 如果只是简单的 path，直接传字符串\n   *\n   * push('/index')\n   *\n   * 如果需要带参数，可传对象\n   *\n   * push({\n   *   path: '/index',\n   *   params: { },\n   *   query: { }\n   * })\n   *\n   * 如果路由配置了 name，可用 name 代替 path，如下：\n   *\n   * push({\n   *   name: 'index'\n   * })\n   *\n   */\n  push(target: routerType.Target) {\n\n    const instance = this, { mode } = instance\n\n    instance.setUrl(\n      toUrl(target, instance.name2Path),\n      env.EMPTY_FUNCTION,\n      env.EMPTY_FUNCTION,\n      function (location, pending) {\n        instance.pending = pending\n        if (mode.current() !== location.url) {\n          mode.push(location, instance.handler)\n        }\n        else {\n          instance.setRoute(location)\n        }\n      }\n    )\n\n  }\n\n  /**\n   * 不改变 URL，只修改路由组件\n   */\n  replace(target: routerType.Target) {\n\n    const instance = this\n\n    instance.setUrl(\n      toUrl(target, instance.name2Path),\n      function () {\n        instance.replaceHistory(instance.location as Location)\n      },\n      env.EMPTY_FUNCTION,\n      function (location, pending) {\n        instance.pending = pending\n        instance.setRoute(location)\n      }\n    )\n\n  }\n\n  /**\n   * 前进或后退 n 步\n   */\n  go(n: number) {\n\n    const instance = this,\n\n    { mode } = instance,\n\n    cursor = instance.cursor + n,\n\n    location = instance.history[cursor]\n\n    if (location) {\n      instance.setUrl(\n        stringifyUrl(location.path, location.params, location.query),\n        env.EMPTY_FUNCTION,\n        env.EMPTY_FUNCTION,\n        function (location, pending) {\n          pending.cursor = cursor\n          instance.pending = pending\n\n          if (mode.current() !== location.url) {\n            mode.go(n)\n          }\n          else {\n            instance.setHistory(location, cursor)\n            instance.setRoute(location)\n          }\n        }\n      )\n    }\n\n  }\n\n  /**\n   * 启动路由\n   */\n  start() {\n    this.mode.start(domApi, this.handler)\n  }\n\n  /**\n   * 停止路由\n   */\n  stop() {\n    this.mode.stop(domApi, this.handler)\n  }\n\n  /**\n   * 钩子函数\n   */\n  hook(route: routerType.LinkedRoute, componentHook: string, hook: string, isGuard?: boolean, callback?: routerType.Callback) {\n\n    const instance = this, { location, hooks, pending } = instance\n\n    hooks\n      .clear()\n      // 先调用组件的钩子\n      .add((route.component as YoxOptions)[componentHook], route.context)\n      // 再调用路由配置的钩子\n      .add(route.route[hook], route.route)\n      // 最后调用路由实例的钩子\n      .add(instance.options[hook], instance)\n\n    const next = function (value?: false | routerType.Target) {\n      if (value === env.UNDEFINED) {\n        hooks.next(next, isGuard, callback)\n      }\n      else {\n        // 只有前置守卫才有可能走进这里\n        // 此时 instance.location 还是旧地址\n        if (pending) {\n          pending.onAbort()\n          instance.pending = env.UNDEFINED\n        }\n        if (value === env.FALSE) {\n          if (location) {\n            instance.push(location)\n          }\n        }\n        else {\n          // 跳转到别的路由\n          instance.push(value)\n        }\n      }\n    }\n\n    next()\n\n  }\n\n  private setHistory(location: Location, index: number | void) {\n\n    const { history, cursor } = this\n\n    // 如果没传 cursor，表示 push\n    if (!Yox.is.number(index)) {\n      index = cursor + 1\n      // 确保下一个为空\n      // 如果不为空，肯定是调用过 go()，此时直接清掉后面的就行了\n      if (history[index]) {\n        history.length = index\n      }\n    }\n\n    history[index as number] = location\n\n    this.cursor = index as number\n\n  }\n\n  private replaceHistory(location: Location) {\n    const { history, cursor } = this\n    if (history[cursor]) {\n      history[cursor] = location\n    }\n  }\n\n  private setUrl(\n    url: string,\n    onComplete: routerType.Callback,\n    onAbort: routerType.Callback,\n    callback: (locaiton: Location, pending: routerType.Pending) => void\n  ) {\n\n    // 这里无需判断新旧 url 是否相同，因为存在 replace，即使它们相同也不等价于不用跳转\n    const instance = this\n\n    instance.parseLocation(\n      url,\n      function (location) {\n\n        if (location) {\n          callback(\n            location,\n            {\n              location,\n              onComplete,\n              onAbort,\n            }\n          )\n        }\n        else if (process.env.NODE_ENV === 'development') {\n          Yox.logger.error(`\"${url}\" can't match a route.`)\n        }\n\n      }\n    )\n\n  }\n\n  private parseLocation(url: string, callback: (location: Location | void) => void) {\n\n    let realpath: string, search: string | void, index = url.indexOf(constant.SEPARATOR_SEARCH)\n\n    if (index >= 0) {\n      realpath = url.slice(0, index)\n      search = url.slice(index + 1)\n    }\n    else {\n      realpath = url\n    }\n\n    // 匹配已注册的 route\n    const instance = this,\n\n    realpathTerms = realpath.split(constant.SEPARATOR_PATH),\n\n    length = realpathTerms.length,\n\n    matchRoute = function (\n      routes: routerType.LinkedRoute[],\n      callback: (route?: routerType.LinkedRoute, params?: type.data) => void\n    ) {\n\n      let index = 0, route: routerType.LinkedRoute | void\n\n      loop: while (route = routes[index++]) {\n        const path = route.path\n\n        // 动态路由\n        if (route.params) {\n          const pathTerms = path.split(constant.SEPARATOR_PATH)\n          // path 段数量必须一致，否则没有比较的意义\n          if (length === pathTerms.length) {\n            const params: type.data = {}\n            for (let i = 0; i < length; i++) {\n              if (Yox.string.startsWith(pathTerms[i], constant.PREFIX_PARAM)) {\n                params[pathTerms[i].substr(constant.PREFIX_PARAM.length)] = valueUtil.parse(Yox, realpathTerms[i])\n              }\n              // 非参数段不相同\n              else if (pathTerms[i] !== realpathTerms[i]) {\n                continue loop\n              }\n            }\n            callback(route, params)\n            return\n          }\n        }\n        // 懒加载路由，前缀匹配成功后，意味着懒加载回来的路由一定有我们想要的\n        else if (route.load && Yox.string.startsWith(realpath, path)) {\n          route.load(\n            function (lazyRoute) {\n              instance.remove(route as routerType.LinkedRoute)\n              matchRoute(\n                instance.add(lazyRoute),\n                callback\n              )\n            }\n          )\n          return\n        }\n        else if (path === realpath) {\n          callback(route)\n          return\n        }\n      }\n\n      callback()\n\n    }\n\n    matchRoute(\n      instance.routes,\n      function (route, params) {\n        if (route) {\n          const location: Location = {\n            url,\n            path: route.path\n          }\n          if (params) {\n            location.params = params\n          }\n          if (search) {\n            const query = queryUtil.parse(Yox, search)\n            if (query) {\n              location.query = query\n            }\n          }\n          callback(location)\n        }\n        else {\n          callback()\n        }\n      }\n    )\n\n  }\n\n  private diffRoute(\n    route: routerType.LinkedRoute,\n    oldRoute: routerType.LinkedRoute | void,\n    onComplete: (route: routerType.LinkedRoute, startRoute: routerType.LinkedRoute | void) => void,\n    startRoute: routerType.LinkedRoute | void,\n    childRoute: routerType.LinkedRoute | void,\n    oldTopRoute: routerType.LinkedRoute | void\n  ) {\n\n    // 更新链路\n    if (childRoute) {\n      route.child = childRoute\n      childRoute.parent = route\n    }\n\n    if (oldRoute) {\n      // 同级的两个组件不同，疑似起始更新的路由\n      if (oldRoute.component !== route.component) {\n        startRoute = route\n      }\n      else {\n        // 把上次的组件实例搞过来\n        route.context = oldRoute.context\n      }\n    }\n    else {\n      startRoute = route\n    }\n\n    if (route.parent) {\n      this.diffRoute(\n        Yox.object.copy(route.parent),\n        oldRoute ? oldRoute.parent : env.UNDEFINED,\n        onComplete,\n        startRoute,\n        route,\n        oldRoute || oldTopRoute\n      )\n      return\n    }\n\n    // 整个组件树全换掉\n    if (startRoute === route) {\n      let context: Yox | void\n      // 当层级较多的路由切换到层级较少的路由\n      if (oldRoute) {\n        while (oldRoute) {\n          context = oldRoute.context\n          oldRoute = oldRoute.parent\n        }\n      }\n      // 当层级较少的路由切换到层级较多的路由\n      else if (oldTopRoute) {\n        context = oldTopRoute.context\n      }\n      if (context) {\n        startRoute.context = context\n      }\n    }\n\n    // 到达根组件，结束\n    onComplete(route, startRoute)\n\n  }\n\n  private patchRoute(\n    route: routerType.LinkedRoute,\n    startRoute: routerType.LinkedRoute | void\n  ) {\n\n    const instance = this, location = instance.location as Location\n\n    // 从上往下更新 props\n    while (route) {\n\n      let { parent, context, component } = route\n\n      if (route === startRoute) {\n\n        if (parent) {\n\n          context = parent.context as Yox\n          context.forceUpdate(\n            filterProps(\n              parent,\n              location,\n              parent.component as YoxOptions\n            )\n          )\n\n          context = context[ROUTE_VIEW]\n          if (context) {\n            const props = {}, name = ROUTE_COMPONENT + (++guid)\n            props[ROUTE_COMPONENT] = name\n            context.component(name, component)\n            context.forceUpdate(props)\n          }\n\n        }\n        else {\n\n          if (context) {\n            context.destroy()\n          }\n\n          // 每层路由组件都有 $route 和 $router 属性\n          const extensions = {}\n          extensions[ROUTER] = instance\n          extensions[ROUTE] = route\n\n          route.context = new Yox(\n            Yox.object.extend(\n              {\n                el: instance.el,\n                props: filterProps(route, location, component as YoxOptions),\n                extensions,\n              },\n              component as YoxOptions\n            )\n          )\n\n        }\n\n      }\n\n      else if (context) {\n        if (context.$vnode) {\n          context[ROUTE] = route\n          context.forceUpdate(\n            filterProps(route, location, component as YoxOptions)\n          )\n        }\n        else {\n          route.context = env.UNDEFINED\n        }\n        if (route.child) {\n          route = route.child as routerType.LinkedRoute\n          continue\n        }\n      }\n      break\n    }\n  }\n\n  private setRoute(location: Location) {\n\n    let instance = this,\n\n    linkedRoute = instance.path2Route[location.path],\n\n    redirect = linkedRoute.route.redirect\n\n    if (redirect) {\n      if (Yox.is.func(redirect)) {\n        redirect = (redirect as routerType.Redirect)(location)\n      }\n      if (redirect) {\n        instance.push(redirect as routerType.Target)\n        return\n      }\n    }\n\n    const newRoute = Yox.object.copy(linkedRoute),\n\n    oldRoute = instance.route,\n\n    oldLocation = instance.location,\n\n    enterRoute = function () {\n      instance.diffRoute(\n        newRoute,\n        oldRoute,\n        function (route, startRoute) {\n          instance.hook(\n            newRoute,\n            startRoute ? config.HOOK_BEFORE_ROUTE_ENTER : config.HOOK_BEFORE_ROUTE_UPDATE,\n            startRoute ? constant.HOOK_BEFORE_ENTER : constant.HOOK_BEFORE_UPDATE,\n            env.TRUE,\n            function () {\n\n              instance.route = newRoute\n              instance.location = location\n\n              instance.patchRoute(route, startRoute)\n\n            }\n          )\n        }\n      )\n    }\n\n    instance.hooks.setLocation(location, oldLocation)\n\n    if (oldRoute && oldLocation && location.path !== oldLocation.path) {\n      instance.hook(\n        oldRoute,\n        config.HOOK_BEFORE_ROUTE_LEAVE,\n        constant.HOOK_BEFORE_LEAVE,\n        env.TRUE,\n        enterRoute\n      )\n      return\n    }\n\n    enterRoute()\n\n  }\n\n}\n\nconst default404 = {\n  path: '/404',\n  component: {\n    template: '<div>This is a default 404 page, please set \"route404\" for your own 404 page.</div>'\n  }\n},\n\ndirective = {\n  bind(node: HTMLElement | Yox, directive: Directive, vnode: VNode) {\n\n    // 当前组件如果是根组件，则没有 $root 属性\n    const $root = vnode.context.$root || vnode.context,\n\n    router = $root[ROUTER] as Router,\n\n    listener = vnode.data[directive.key] = function (_: CustomEvent) {\n      let { value, getter } = directive, target: any = value\n      if (value && getter && Yox.string.has(value as string, '{')) {\n        target = getter()\n      }\n      router[directive.name](target)\n    }\n\n    if (vnode.isComponent) {\n      (node as Yox).on(EVENT_CLICK, listener)\n    }\n    else {\n      domApi.on(node as HTMLElement, EVENT_CLICK, listener)\n    }\n\n  },\n  unbind(node: HTMLElement | Yox, directive: Directive, vnode: VNode) {\n    const listener = vnode.data[directive.key]\n    if (vnode.isComponent) {\n      (node as Yox).off(EVENT_CLICK, listener)\n    }\n    else {\n      domApi.off(node as HTMLElement, EVENT_CLICK, listener)\n    }\n  },\n},\n\nRouterView: YoxOptions = {\n  template: '<$' + ROUTE_COMPONENT + '/>',\n  beforeCreate(options) {\n\n    const context = options.context as Yox,\n\n    route = context[ROUTE].child as routerType.LinkedRoute\n\n    if (route) {\n\n      context[ROUTE_VIEW] = this\n\n      const props = options.props = {}, components = options.components = {},\n\n      name = ROUTE_COMPONENT + (++guid)\n\n      props[ROUTE_COMPONENT] = name\n      components[name] = route.component\n\n    }\n\n  },\n  beforeDestroy() {\n    this.$context[ROUTE_VIEW] = env.UNDEFINED\n  }\n}\n\n/**\n * 版本\n */\nexport const version = process.env.NODE_VERSION\n\n/**\n * 安装插件\n */\nexport function install(Class: YoxClass): void {\n\n  Yox = Class\n  domApi = Class.dom as API\n\n  Yox.directive({\n    push: directive,\n    replace: directive,\n    go: directive,\n  })\n\n  Yox.component('router-view', RouterView)\n\n  const { beforeCreate, afterMount, afterUpdate, afterDestroy } = Yox\n\n  Yox.beforeCreate = function (options) {\n\n    if (beforeCreate) {\n      beforeCreate(options)\n    }\n\n    let { context } = options\n\n    // 当前组件是 <router-view> 中的动态组件\n    if (context && context.$options.beforeCreate === RouterView.beforeCreate) {\n      // 找到渲染 <router-view> 的父级组件，它是一定存在的\n      context = context.$context as Yox\n\n      const router = context[ROUTER] as Router,\n\n      route = context[ROUTE].child as routerType.LinkedRoute\n\n      if (route) {\n        const extensions = options.extensions = {}\n        extensions[ROUTER] = router\n        extensions[ROUTE] = route\n\n        if (router.location) {\n          options.props = filterProps(route, router.location, options)\n        }\n      }\n\n    }\n\n  }\n\n  Yox.afterMount = function (instance) {\n\n    updateRoute(instance, afterMount, config.HOOK_AFTER_ROUTE_ENTER, constant.HOOK_AFTER_ENTER, env.TRUE)\n\n  }\n  Yox.afterUpdate = function (instance) {\n\n    updateRoute(instance, afterUpdate, config.HOOK_AFTER_ROUTE_UPDATE, constant.HOOK_AFTER_UPDATE, env.TRUE)\n\n  }\n  Yox.afterDestroy = function (instance) {\n\n    updateRoute(instance, afterDestroy, config.HOOK_AFTER_ROUTE_LEAVE, constant.HOOK_AFTER_LEAVE)\n\n  }\n\n}\n","\nimport YoxClass from '../../../yox-type/src/interface/YoxClass'\n\nimport * as constant from '../constant'\nimport * as valueUtil from './value'\n\n/**\n * 把 GET 参数解析成对象\n */\nexport function parse(Yox: YoxClass, query: string) {\n  let result: Object | undefined\n  Yox.array.each(\n    query.split(constant.SEPARATOR_QUERY),\n    function (term) {\n\n      let terms = term.split(constant.SEPARATOR_PAIR),\n\n      key = Yox.string.trim(terms[0]),\n\n      value = terms[1]\n\n      if (key) {\n        if (!result) {\n          result = {}\n        }\n        value = valueUtil.parse(Yox, value)\n        if (Yox.string.endsWith(key, constant.FLAG_ARRAY)) {\n          key = Yox.string.slice(key, 0, -constant.FLAG_ARRAY.length)\n          Yox.array.push(\n            result[key] || (result[key] = []),\n            value\n          )\n        }\n        else {\n          result[key] = value\n        }\n      }\n\n    }\n  )\n  return result\n}\n\n/**\n * 把对象解析成 key1=value1&key2=value2\n */\nexport function stringify(Yox: YoxClass, query: Object) {\n  const result: string[] = []\n  for (let key in query) {\n    const value = query[key]\n    if (Yox.is.array(value)) {\n      Yox.array.each(\n        value,\n        function (value) {\n          const str = valueUtil.stringify(Yox, value)\n          if (Yox.is.string(str)) {\n            result.push(\n              key + constant.FLAG_ARRAY + constant.SEPARATOR_PAIR + str\n            )\n          }\n        }\n      )\n    }\n    else {\n      const str = valueUtil.stringify(Yox, value)\n      if (Yox.is.string(str)) {\n        result.push(\n          key + constant.SEPARATOR_PAIR + str\n        )\n      }\n    }\n  }\n  return result.join(constant.SEPARATOR_QUERY)\n}\n"],"names":["const","HOOK_AFTER_ROUTE_ENTER","HOOK_AFTER_ROUTE_UPDATE","HOOK_AFTER_ROUTE_LEAVE","TRUE","FALSE","NULL","UNDEFINED","RAW_TRUE","RAW_FALSE","RAW_NULL","EMPTY_FUNCTION","Object","freeze","Hooks","to","from","this","list","hook","ctx","push","fn","next","isGuard","callback","task","shift","call","WINDOW","window","LOCATION","location","HISTORY","history","PREFIX_PARAM","SEPARATOR_PATH","SEPARATOR_SEARCH","SEPARATOR_QUERY","SEPARATOR_PAIR","FLAG_ARRAY","HOOK_AFTER_ENTER","HOOK_AFTER_UPDATE","HOOK_AFTER_LEAVE","parse","Yox","value","result","is","numeric","string","env.RAW_TRUE","env.TRUE","env.RAW_FALSE","env.FALSE","env.RAW_NULL","env.NULL","decodeURIComponent","stringify","encodeURIComponent","number","boolean","toString","HASH_PREFIX","HASH_CHANGE","domApi","handler","on","constant.WINDOW","off","constant.LOCATION","hash","url","n","constant.HISTORY","go","href","index","indexOf","substr","length","constant.SEPARATOR_PATH","POP_STATE","isSupported","pushState","pathname","search","guid","ROUTER","ROUTE","formatPath","path","parentPath","startsWith","endsWith","slice","stringifyUrl","params","query","test","terms_1","array","each","split","item","constant.PREFIX_PARAM","join","queryStr","key","str","valueUtil.stringify","constant.FLAG_ARRAY","constant.SEPARATOR_PAIR","constant.SEPARATOR_QUERY","queryUtil.stringify","constant.SEPARATOR_SEARCH","toUrl","target","name2Path","route","name","filterProps","options","propTypes","props","routeParams","locationParams","object","copy","i","env.UNDEFINED","updateRoute","instance","componentHookName","hookName","upsert","context","child","isLeafRoute","router","pending","onComplete","el","route404","default404","find","mode","historyMode.isSupported","historyMode","hashMode","current","setHistory","cursor","setRoute","parseLocation","routes","path2Route","hooks","add","Router","routeOptions","newRoutes","pathStack","routeStack","addRoute","component","children","load","last","parentRoute","parent","pop","remove","setUrl","env.EMPTY_FUNCTION","replaceHistory","start","stop","componentHook","clear","onAbort","realpath","realpathTerms","matchRoute","loop","pathTerms","valueUtil.parse","lazyRoute","term","terms","trim","queryUtil.parse","oldRoute","startRoute","childRoute","oldTopRoute","diffRoute","forceUpdate","destroy","extensions","extend","$vnode","linkedRoute","redirect","func","newRoute","oldLocation","enterRoute","patchRoute","setLocation","template","directive","bind","node","vnode","$root","listener","data","_","getter","has","isComponent","unbind","RouterView","beforeCreate","components","beforeDestroy","$context","Class","dom","replace","afterMount","afterUpdate","afterDestroy","$options","config.HOOK_AFTER_ROUTE_ENTER","constant.HOOK_AFTER_ENTER","config.HOOK_AFTER_ROUTE_UPDATE","constant.HOOK_AFTER_UPDATE","config.HOOK_AFTER_ROUTE_LEAVE","constant.HOOK_AFTER_LEAVE"],"mappings":"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"}