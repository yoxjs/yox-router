import t from"yox";const e=window,n=e.location,o=e.history;class r{setLocation(t,e){return this.to=t,this.from=e,this}clear(){return this.list=[],this}add(t,e){const{list:n}=this;return t&&n.push({fn:t,ctx:e}),this}next(t,e,n){const o=this.list.shift();o?t?o.fn.call(o.ctx,this.to,this.from,e):(o.fn.call(o.ctx,this.to,this.from),e()):n()}}function i(e){let n;return t.is.numeric(e)?n=+e:t.is.string(e)&&(n="true"===e||"false"!==e&&("null"===e?null:decodeURIComponent(e))),n}function s(e){return t.is.string(e)?encodeURIComponent(e):t.is.number(e)||t.is.boolean(e)?e.toString():null===e?"null":void 0}const a="pushState"in o;function c(t,e){try{o.replaceState({},"",t),e()}catch(e){n.replace(t)}}var u=Object.freeze({__proto__:null,isSupported:a,start:function(n){t.dom.on(e,"popstate",n),n()},stop:function(n){t.dom.off(e,"popstate",n)},push:function(t,e){o.pushState({},"",t.url),e()},replace:function(t,e){c(t.url,e)},go:function(t){o.go(t)},current:function(){return n.pathname+n.search},replaceState:c});var l=Object.freeze({__proto__:null,start:function(n){t.dom.on(e,"hashchange",n),n()},stop:function(n){t.dom.off(e,"hashchange",n)},push:function(t,e){n.hash="#!"+t.url},replace:function(t,e){const o=n.protocol+"//"+n.host+n.pathname+"#!"+t.url;a?c(o,e):n.replace(o)},go:function(t){o.go(t)},current:function(){const t=n.href,e=t.indexOf("#!");return e>0?t.substr(e+"#!".length):"/"}}),f=function(t,e,n,o,r,i,s,a,c,u,l,f,p,h,d,m,g,x,y,b,R,C,$,v,U,k,w,L,j,W,_,S,P,E,O,q,V){q[q.length]={context:v,isPure:!0,isStatic:!0,tag:"div",text:'This is a default 404 page, please set "route404" for your own 404 page.',type:3}},p=function(t,e,n,o,r,i,s,a,c,u,l,f,p,h,d,m,g,x,y,b,R,C,$,v,U,k,w,L,j,W,_,S,P,E,O,q,V){q[q.length]=V[V.length]={context:v,isComponent:!0,tag:"router-view",type:4}},h=function(t,e,n,o,r,i,s,a,c,u,l,f,p,h,d,m,g,x,y,b,R,C,$,v,U,k,w,L,j,W,_,S,P,E,O,q,V){q[q.length]=V[V.length]={context:v,isComponent:!0,tag:d("RouteComponent",E.RouteComponent).value,type:4}};let d=0;function m(e,n){return t.string.startsWith(e,"/")||(n?t.string.endsWith(n,"/")||(n+="/"):n="/",e=n+e),"/"!==e&&t.string.endsWith(e,"/")&&(e=t.string.slice(e,0,-"/".length)),e}function g(e,n,o){if(/\/\:\w+/.test(e)){const o=[];t.array.each(e.split("/"),(function(e){o.push(t.string.startsWith(e,":")&&n?n[e.substr(":".length)]:e)})),e=o.join("/")}if(o){const n=function(e){const n=[];for(let o in e){const r=e[o];if(t.is.array(r))t.array.each(r,(function(e){const r=s(e);t.is.string(r)&&n.push(o+"[]="+r)}));else{const e=s(r);t.is.string(e)&&n.push(o+"="+e)}}return n.join("&")}(o);n&&(e+="?"+n)}return e}function x(e,n,o){const r={},i=o.propTypes;if(i){let o=n.query,s=e.params,a=n.params;if(s&&a){o=o?t.object.copy(o):{};for(let t=0,e=s.length;t<e;t++)o[s[t]]=a[s[t]]}if(o)for(let t in i){let e=o[t];undefined!==e&&(r[t]=e)}}return r}function y(t,e,n,o){const r=t.$route;if(r&&(r.context=o?t:undefined,function(t){const e=t.child;return!e||!e.context}(r))){const i=t.$router;if(e&&n&&i.hook(r,e,n,false),o){const{pending:t}=i;t&&(t.onComplete(),i.pending=undefined)}}}class b{constructor(e){const n=this,o=e.el,i=e.route404||R;n.options=e,n.el=t.is.string(o)?t.dom.find(o):o,n.mode="history"===e.mode&&a?u:l,n.handler=function(){n.parseLocation(n.mode.current(),(function(t){t?n.setRoute(t):n.push(n.route404)}))},n.routes=[],n.name2Path={},n.path2Route={},n.hooks=new r,t.array.each(e.routes,(function(t){n.add(t)})),n.route404=n.add(i)[0]}add(e,n){const o=this,r=[],i=[],s=[],a=function(e){let{name:n,component:c,children:u,load:l}=e,f=t.array.last(i),p=t.array.last(s),h=m(e.path,f),d={path:h,route:e},g=[];t.array.each(h.split("/"),(function(e){t.string.startsWith(e,":")&&g.push(e.substr(":".length))})),g.length&&(d.params=g),n&&(d.name=n),l?d.load=l:d.component=c||C,p&&(d.parent=p),u?(i.push(h),s.push(d),t.array.each(u,a),s.pop(),i.pop()):(r.push(d),o.routes.push(d),n&&(o.name2Path[n]=h),o.path2Route[h]=d)};return n&&(i.push(n.path),s.push(n)),a(e),r}remove(e){const n=this;t.array.remove(n.routes,e),e.name&&delete n.name2Path[e.name],delete n.path2Route[e.path]}push(t){const e=this,{mode:n}=e;e.setUrl(e.toUrl(t),(function(t){n.current()!==t.url&&n.push(t,e.handler)}))}replace(t){const e=this,{mode:n}=e;e.setUrl(e.toUrl(t),(function(t){n.current()!==t.url&&n.replace(t,e.handler)}))}go(t){this.mode.go(t)}start(){this.mode.start(this.handler)}stop(){this.mode.stop(this.handler)}hook(e,n,o,r,i){const s=this,{location:a,hooks:c,pending:u}=s,{context:l}=e,f=function(){l&&t.lifeCycle.fire(l,n,{from:c.from,to:c.to}),i&&i()},p=function(t){undefined===t?c.next(r,p,f):(u&&(u.onAbort(),s.pending=undefined),false===t?a&&s.push(a):s.push(t))};c.clear().add(e.component[n],l).add(e.route[o],e.route).add(s.options[o],s),p()}toUrl(e){if(t.is.string(e))return m(e);let n,o=this,r=o.location,i=e,s=i.params;return i.name?n=o.name2Path[i.name]:i.path?n=m(i.path):r&&(n=r.path,s||(s=r.params)),g(n,s,i.query)}setUrl(t,e){this.parseLocation(t,(function(t){t&&e(t)}))}parseLocation(e,n){let o,r,s=e.indexOf("?");s>=0?(o=e.slice(0,s),r=e.slice(s+1)):o=e;const a=this,{options:c,routes:u,location:l}=a,f=o.split("/"),p=f.length,h=function(n,o){const s={url:e,path:n.path};if(o&&(s.params=o),r){const e=function(e){let n;return t.array.each(e.split("&"),(function(e){let o=e.split("="),r=t.string.trim(o[0]),s=o[1];r&&(n||(n={}),s=i(s),t.string.endsWith(r,"[]")?(r=t.string.slice(r,0,-"[]".length),t.array.push(n[r]||(n[r]=[]),s)):n[r]=s)})),n}(r);e&&(s.query=e)}return s},d=function(e,n){const r=e.path;if(e.params){const o=r.split("/");if(p===o.length){const r={};for(let e=0;e<p;e++)if(t.string.startsWith(o[e],":"))r[o[e].substr(":".length)]=i(f[e]);else if(o[e]!==f[e])return;return n(h(e,r))}}else{if(e.load&&t.string.startsWith(o,r)){if(e.loading)return true;const r=c.beforeLoad,i=c.afterLoad,s=function(r){a.remove(e);let s=r.default||r;t.is.func(s)&&(s=s());const c=a.add(s,e.parent);e.loading=false,l===a.location?m(c,(function(t){return i&&i.call(a,o,t),n(t)})):i&&i.call(a,o)};e.loading=true,r&&r.call(a,o);const u=e.load(s);return u&&u.then(s),true}if(r===o)return n(h(e))}},m=function(t,e){for(let n=0,o=t.length;n<o;n++)if(d(t[n],e))return;e()};m(u,(function(t){return n(t),true}))}diffRoute(e,n,o,r,i,s){if(i&&(e.child=i,i.parent=e),n?n.component!==e.component?r=e:e.context=n.context:r=e,e.parent)this.diffRoute(t.object.copy(e.parent),n?n.parent:undefined,o,r,e,n||s);else{if(r===e){let t;if(n)for(;n;)t=n.context,n=n.parent;else s&&(t=s.context);t&&(r.context=t)}o(e,r)}}patchRoute(e,n){const o=this,r=o.location;for(;e;){let{parent:i,context:s,component:a}=e;if(e===n)if(i){if(s=i.context,s.forceUpdate(x(i,r,i.component)),s=s.$routeView,s){const t={},e="RouteComponent"+ ++d;t.RouteComponent=e,s.component(e,a),s.forceUpdate(t)}}else s&&s.destroy(),e.context=new t(t.object.extend({el:o.el,props:x(e,r,a),extensions:{$router:o,$route:e}},a));else if(s&&(s.$vnode?(s.$route=e,s.forceUpdate(x(e,r,a))):e.context=undefined,e.child)){e=e.child;continue}break}}setRoute(e){let n=this,o=n.path2Route[e.path],r=o.route.redirect;if(r&&(t.is.func(r)&&(r=r(e)),r))return void n.push(r);const i=t.object.copy(o),s=n.route,a=n.location,c=function(){n.diffRoute(i,s,(function(t,o){n.hook(i,o?"beforeRouteEnter":"beforeRouteUpdate",o?"beforeEnter":"beforeUpdate",true,(function(){n.route=i,n.location=e,n.patchRoute(t,o)}))}))};n.hooks.setLocation(e,a),s&&a&&e.path!==a.path?n.hook(s,"beforeRouteLeave","beforeLeave",true,c):c()}}const R={path:"/404",component:{template:f}},C={template:p},$={bind(e,n,o){const r=(o.context.$root||o.context).$router,i=o.data[n.key]=function(e){let{value:o,getter:i}=n,s=o;o&&i&&t.string.has(o,"{")&&(s=i()),r[n.name](s)};o.isComponent?e.on("click",i):t.dom.on(e,"click",i)},unbind(e,n,o){const r=o.data[n.key];o.isComponent?e.off("click",r):t.dom.off(e,"click",r)}},v={template:h,beforeCreate(t){const e=t.context,n=e.$route.child;if(n){e.$routeView=this;const o=t.props={},r=t.components={},i="RouteComponent"+ ++d;o.RouteComponent=i,r[i]=n.component}},beforeDestroy(){this.$context.$routeView=undefined}};t.lifeCycle.on("beforeCreate",(function(t,e){let n=e.options,{context:o}=n;if(o&&o.$options.beforeCreate===v.beforeCreate){o=o.$context;const t=o.$router,e=o.$route.child;e&&(n.extensions={$router:t,$route:e},t.location&&(n.props=x(e,t.location,n)))}})).on("afterMount",(function(t){y(t,"afterRouteEnter","afterEnter",true)})).on("afterUpdate",(function(t){y(t,"afterRouteUpdate","afterUpdate",true)})).on("afterDestroy",(function(t){y(t,"afterRouteLeave","afterLeave")}));const U="1.0.0-alpha.125";function k(t){t.directive({push:$,replace:$,go:$}),t.component("router-view",v)}export{b as Router,k as install,U as version};
//# sourceMappingURL=yox-router.esm.min.js.map
