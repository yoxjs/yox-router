import t from"yox";const e=window,o=e.location,n=e.history;class r{setLocation(t,e){return this.to=t,this.from=e,this}clear(){return this.list=[],this}add(t,e){const{list:o}=this;return t&&o.push({fn:t,ctx:e}),this}next(t,e,o){const n=this.list.shift();n?t?n.fn.call(n.ctx,this.to,this.from,e):(n.fn.call(n.ctx,this.to,this.from),e()):o()}}function s(e){let o;return t.is.numeric(e)?o=+e:t.is.string(e)&&(o="true"===e||"false"!==e&&("null"===e?null:decodeURIComponent(e))),o}function i(e){return t.is.string(e)?encodeURIComponent(e):t.is.number(e)||t.is.boolean(e)?e.toString():null===e?"null":void 0}const a="pushState"in n;function c(t,e){try{n.replaceState({},"",t),e()}catch(e){o.replace(t)}}var u=Object.freeze({__proto__:null,isSupported:a,start:function(o){t.dom.on(e,"popstate",o),o()},stop:function(o){t.dom.off(e,"popstate",o)},push:function(t,e){n.pushState({},"",t.url),e()},replace:function(t,e){c(t.url,e)},go:function(t){n.go(t)},current:function(){return o.pathname+o.search},replaceState:c});var p=Object.freeze({__proto__:null,start:function(o){t.dom.on(e,"hashchange",o),o()},stop:function(o){t.dom.off(e,"hashchange",o)},push:function(t,e){o.hash="#!"+t.url},replace:function(t,e){const n=o.protocol+"//"+o.host+o.pathname+"#!"+t.url;a?c(n,e):o.replace(n)},go:function(t){n.go(t)},current:function(){const t=o.href,e=t.indexOf("#!");return e>0?t.substr(e+"#!".length):"/"}});let h,l=0;function f(e,o){return t.string.startsWith(e,"/")||(o?t.string.endsWith(o,"/")||(o+="/"):o="/",e=o+e),"/"!==e&&t.string.endsWith(e,"/")&&(e=t.string.slice(e,0,-"/".length)),e}function d(e,o,n){if(/\/\:\w+/.test(e)){const n=[];t.array.each(e.split("/"),(function(e){n.push(t.string.startsWith(e,":")&&o?o[e.substr(":".length)]:e)})),e=n.join("/")}if(n){const o=function(e){const o=[];for(let n in e){const r=e[n];if(t.is.array(r))t.array.each(r,(function(e){const r=i(e);t.is.string(r)&&o.push(n+"[]="+r)}));else{const e=i(r);t.is.string(e)&&o.push(n+"="+e)}}return o.join("&")}(n);o&&(e+="?"+o)}return e}function m(e,o,n){const r={},s=n.propTypes;if(s){let n=o.query,i=e.params,a=o.params;if(i&&a){n=n?t.object.copy(n):{};for(let t=0,e=i.length;t<e;t++)n[i[t]]=a[i[t]]}if(n)for(let t in s){let e=n[t];void 0!==e&&(r[t]=e)}}return r}function g(t,e,o,n){const r=t.$route;if(r&&(r.context=n?t:void 0,function(t){const e=t.child;return!e||!e.context}(r))){const s=t.$router;if(e&&o&&s.hook(r,e,o,!1),n){const{pending:t}=s;t&&(t.onComplete(),s.pending=void 0)}}}class v{constructor(e){const o=this,n=e.el,s=e.route404||x;o.options=e,o.el=t.is.string(n)?t.dom.find(n):n,o.mode="history"===e.mode&&a?u:p,o.handler=function(){o.parseLocation(o.mode.current(),(function(t){t?o.setRoute(t):o.push(o.route404)}))},o.routes=[],o.name2Path={},o.path2Route={},o.hooks=new r,t.array.each(e.routes,(function(t){o.add(t)})),o.route404=o.add(s)[0]}add(e,o){const n=this,r=[],s=[],i=[],a=function(e){let{name:o,component:c,children:u,load:p}=e,h=t.array.last(s),l=t.array.last(i),d=f(e.path,h),m={path:d,route:e},g=[];t.array.each(d.split("/"),(function(e){t.string.startsWith(e,":")&&g.push(e.substr(":".length))})),g.length&&(m.params=g),o&&(m.name=o),p?m.load=p:m.component=c||y,l&&(m.parent=l),u?(s.push(d),i.push(m),t.array.each(u,a),i.pop(),s.pop()):(r.push(m),n.routes.push(m),o&&(n.name2Path[o]=d),n.path2Route[d]=m)};return o&&(s.push(o.path),i.push(o)),a(e),r}remove(e){const o=this;t.array.remove(o.routes,e),e.name&&delete o.name2Path[e.name],delete o.path2Route[e.path]}push(t){const e=this,{mode:o}=e;e.setUrl(e.toUrl(t),(function(t){o.current()!==t.url&&o.push(t,e.handler)}))}replace(t){const e=this,{mode:o}=e;e.setUrl(e.toUrl(t),(function(t){o.current()!==t.url&&o.replace(t,e.handler)}))}go(t){this.mode.go(t)}start(){this.mode.start(this.handler)}stop(){this.mode.stop(this.handler)}hook(t,e,o,n,r){const s=this,{location:i,hooks:a,pending:c}=s,{context:u}=t,p=function(){u&&u.fire({type:e,ns:"hook"},{from:a.from,to:a.to}),r&&r()},h=function(t){void 0===t?a.next(n,h,p):(c&&(c.onAbort(),s.pending=void 0),!1===t?i&&s.push(i):s.push(t))};a.clear().add(t.component[e],u).add(t.route[o],t.route).add(s.options[o],s),h()}toUrl(e){if(t.is.string(e))return f(e);let o,n=this,r=n.location,s=e,i=s.params;return s.name?o=n.name2Path[s.name]:s.path?o=f(s.path):r&&(o=r.path,i||(i=r.params)),d(o,i,s.query)}setUrl(t,e){this.parseLocation(t,(function(t){t&&e(t)}))}parseLocation(e,o){let n,r,i=e.indexOf("?");i>=0?(n=e.slice(0,i),r=e.slice(i+1)):n=e;const a=this,c=n.split("/"),u=c.length,p=function(e,o){let r,i=0;t:for(;r=e[i++];){const e=r.path;if(r.params){const n=e.split("/");if(u===n.length){const e={};for(let o=0;o<u;o++)if(t.string.startsWith(n[o],":"))e[n[o].substr(":".length)]=s(c[o]);else if(n[o]!==c[o])continue t;return void o(r,e)}}else{if(r.load&&t.string.startsWith(n,e)){const t=function(t){a.remove(r),p(a.add(t.default||t,r.parent),o)},e=r.load(t);return void(e&&e.then(t))}if(e===n)return void o(r)}}o()};p(a.routes,(function(n,i){if(n){const a={url:e,path:n.path};if(i&&(a.params=i),r){const e=function(e){let o;return t.array.each(e.split("&"),(function(e){let n=e.split("="),r=t.string.trim(n[0]),i=n[1];r&&(o||(o={}),i=s(i),t.string.endsWith(r,"[]")?(r=t.string.slice(r,0,-"[]".length),t.array.push(o[r]||(o[r]=[]),i)):o[r]=i)})),o}(r);e&&(a.query=e)}o(a)}else o()}))}diffRoute(e,o,n,r,s,i){if(s&&(e.child=s,s.parent=e),o?o.component!==e.component?r=e:e.context=o.context:r=e,e.parent)this.diffRoute(t.object.copy(e.parent),o?o.parent:void 0,n,r,e,o||i);else{if(r===e){let t;if(o)for(;o;)t=o.context,o=o.parent;else i&&(t=i.context);t&&(r.context=t)}n(e,r)}}patchRoute(e,o){const n=this,r=n.location;for(;e;){let{parent:s,context:i,component:a}=e;if(e===o)if(s){if(i=s.context,i.forceUpdate(m(s,r,s.component)),i=i.$routeView,i){const t={},e="RouteComponent"+ ++l;t.RouteComponent=e,i.component(e,a),i.forceUpdate(t)}}else{i&&i.destroy();const o={$router:n,$route:e},s=t.object.extend({el:n.el,props:m(e,r,a),extensions:o},a);s.events=s.events?t.object.extend(s.events,h):h,e.context=new t(s)}else if(i&&(i.$vnode?(i.$route=e,i.forceUpdate(m(e,r,a))):e.context=void 0,e.child)){e=e.child;continue}break}}setRoute(e){let o=this,n=o.path2Route[e.path],r=n.route.redirect;if(r&&(t.is.func(r)&&(r=r(e)),r))return void o.push(r);const s=t.object.copy(n),i=o.route,a=o.location,c=function(){o.diffRoute(s,i,(function(t,n){o.hook(s,n?"beforeRouteEnter":"beforeRouteUpdate",n?"beforeEnter":"beforeUpdate",!0,(function(){o.route=s,o.location=e,o.patchRoute(t,n)}))}))};o.hooks.setLocation(e,a),i&&a&&e.path!==a.path?o.hook(i,"beforeRouteLeave","beforeLeave",!0,c):c()}}const x={path:"/404",component:{template:function(t,e,o,n,r,s,i,a,c,u,p,h,l,f,d,m,g,v,x,y,b,R,k,$){return g("div",void 0,(function(){r('This is a default 404 page, please set "route404" for your own 404 page.')}),!0)}}},y={template:function(t,e,o,n,r,s,i,a,c,u,p,h,l,f,d,m,g,v,x,y,b,R,k,$){return v("router-view")}},b={bind(e,o,n){const r=(n.context.$root||n.context).$router,s=n.data[o.key]=function(e){let{value:n,getter:s}=o,i=n;n&&s&&t.string.has(n,"{")&&(i=s()),r[o.name](i)};n.isComponent?e.on("click",s):t.dom.on(e,"click",s)},unbind(e,o,n){const r=n.data[o.key];n.isComponent?e.off("click",r):t.dom.off(e,"click",r)}},R={template:function(t,e,o,n,r,s,i,a,c,u,p,h,l,f,d,m,g,v,x,y,b,R,k,$){return v(t("RouteComponent",!0))},beforeCreate(t){const e=t.context,o=e.$route.child;if(o){e.$routeView=this;const n=t.props={},r=t.components={},s="RouteComponent"+ ++l;n.RouteComponent=s,r[s]=o.component}},beforeDestroy(){this.$context.$routeView=void 0}},k="1.0.0-alpha.58";function $(t){t.directive({push:b,replace:b,go:b}),t.component("router-view",R),h={beforeCreate:{ns:"hook",listener(t,e){if(e){let t=e,{context:o}=t;if(o&&o.$options.beforeCreate===R.beforeCreate){o=o.$context;const e=o.$router,n=o.$route.child;n&&(t.extensions={$router:e,$route:n},e.location&&(t.props=m(n,e.location,t)))}}}},afterMount:{ns:"hook",listener(t){g(t.target,"afterRouteEnter","afterEnter",!0)}},afterUpdate:{ns:"hook",listener(t){g(t.target,"afterRouteUpdate","afterUpdate",!0)}},afterDestroy:{ns:"hook",listener(t){g(t.target,"afterRouteLeave","afterLeave")}}}}export{v as Router,$ as install,k as version};
//# sourceMappingURL=yox-router.esm.min.js.map
